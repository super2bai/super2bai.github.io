<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <link rel="stylesheet" href="/style/style.css">
<script>
  var nlviconfig = {
    title: "贰白",
    author: "super2bai",
    baseUrl: "/",
    theme: {
      scheme: "banderole",
      lightbox: true,
      animate: true,
      search: true,
      friends: false,
      reward: true,
      lazy: false
    }
  }
</script>




    <link rel="stylesheet" href="/script/lib/lightbox/css/lightbox.min.css">




    <link rel="stylesheet" href="/syuanpi/syuanpi.min.css">




    <link rel="icon" href="https://wx4.sinaimg.cn/mw690/8c564d2agy1fq4rsiycy4j202c01wa9v.jpg">




<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-98059014-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-116557847-1');
</script>





    <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="browsermode" content="application">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="贰白">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="msapplication-navbutton-color" content="#666666">
<meta name= "format-detection" content="telephone=no" />
<meta name="keywords" content="nlvi, Nlvi" />

  <link rel="apple-touch-icon"  sizes="72x72"  href="https://wx4.sinaimg.cn/mw690/8c564d2agy1fq4rsiycy4j202c01wa9v.jpg">
  <link rel="apple-touch-icon-precomposed"  sizes="72x72"  href="https://wx4.sinaimg.cn/mw690/8c564d2agy1fq4rsiycy4j202c01wa9v.jpg">


  <meta name="subtitle" content="苦于探索，全是未知">


  <meta name="description" content="苦于探索，全是未知">



  <meta name="keywords" content="es, Nlvi" />

  <title> Elasticsearch查询概述 · 贰白 </title>
</head>
<body>
  <div class="progress">
  <div class="progress-inner"></div>
</div>
  
  
    <div class="tagcloud-mask"></div>  
<div class="tagcloud" id="tagcloud">
  <div class="tagcloud-inner">
    <a href="/tags/Data-Structures/" style="font-size: 14px;">Data Structures</a> <a href="/tags/Docker/" style="font-size: 14px;">Docker</a> <a href="/tags/Dubbo/" style="font-size: 14px;">Dubbo</a> <a href="/tags/GHPages/" style="font-size: 14px;">GHPages</a> <a href="/tags/IO/" style="font-size: 14px;">IO</a> <a href="/tags/JDK/" style="font-size: 14px;">JDK</a> <a href="/tags/JVM/" style="font-size: 14px;">JVM</a> <a href="/tags/Linux/" style="font-size: 14px;">Linux</a> <a href="/tags/MyBatis/" style="font-size: 14px;">MyBatis</a> <a href="/tags/MySQL/" style="font-size: 14px;">MySQL</a> <a href="/tags/Python/" style="font-size: 14px;">Python</a> <a href="/tags/Spring/" style="font-size: 14px;">Spring</a> <a href="/tags/Zookeeper/" style="font-size: 14px;">Zookeeper</a> <a href="/tags/book/" style="font-size: 14px;">book</a> <a href="/tags/code/" style="font-size: 14px;">code</a> <a href="/tags/emacs/" style="font-size: 14px;">emacs</a> <a href="/tags/es/" style="font-size: 14px;">es</a> <a href="/tags/git/" style="font-size: 14px;">git</a> <a href="/tags/github/" style="font-size: 14px;">github</a> <a href="/tags/idea/" style="font-size: 14px;">idea</a> <a href="/tags/jmeter/" style="font-size: 14px;">jmeter</a> <a href="/tags/mac/" style="font-size: 14px;">mac</a> <a href="/tags/monitor/" style="font-size: 14px;">monitor</a> <a href="/tags/server/" style="font-size: 14px;">server</a> <a href="/tags/walkup/" style="font-size: 14px;">walkup</a> <a href="/tags/分布式/" style="font-size: 14px;">分布式</a> <a href="/tags/工具/" style="font-size: 14px;">工具</a> <a href="/tags/并发/" style="font-size: 14px;">并发</a> <a href="/tags/旅游/" style="font-size: 14px;">旅游</a> <a href="/tags/汇编/" style="font-size: 14px;">汇编</a> <a href="/tags/监控/" style="font-size: 14px;">监控</a> <a href="/tags/编码/" style="font-size: 14px;">编码</a>
  </div>
</div>  
  

  <div class="container">

    <header class="header" id="header">
  <div class="header-wrapper">
    <div class="logo">
  <div class="logo-inner syuanpi tvIn">
    <span><a href="/">贰白</a></span>
    
      <span id="subtitle">苦于探索，全是未知</span>
    
  </div>
</div>
    <nav class="main-nav">
  
  <ul class="main-nav-list syuanpi tvIn">
  
    <li class="menu-item">
      <a href="javascript:;" id="search">
        <span>搜索</span>
        
          <span class="menu-item-label">search</span>
        
      </a>
    </li>
  
  
    
      
    
    <li class="menu-item">
      <a href="/" id="article">
        <span class="base-name">文章</span>
        
          <span class="menu-item-label">article</span>
        
      </a>
    </li>
  
    
      
    
    <li class="menu-item">
      <a href="/archives" id="archives">
        <span class="base-name">归档</span>
        
          <span class="menu-item-label">archives</span>
        
      </a>
    </li>
  
    
      
    
    <li class="menu-item">
      <a href="javascript:;" id="tags">
        <span class="base-name">标签</span>
        
          <span class="menu-item-label">tags</span>
        
      </a>
    </li>
  
    
      
    
    <li class="menu-item">
      <a href="/about" id="about">
        <span class="base-name">关于</span>
        
          <span class="menu-item-label">about</span>
        
      </a>
    </li>
  
  </ul>
  
</nav>

    
    
  </div>
</header>
<div class="mobile-header">
  <div class="mobile-header-body">
    <div class="mobile-header-list">
      
        
            <div class="mobile-nav-item">
                <a href="/">
                    <span>文章</span>
                    
                        <span class="menu-item-label">article</span>
                    
                </a>
            </div>
        
      
        
            <div class="mobile-nav-item">
                <a href="/archives">
                    <span>归档</span>
                    
                        <span class="menu-item-label">archives</span>
                    
                </a>
            </div>
        
      
        
          <div class="mobile-nav-item inner-cloud">
            <div class="mobile-nav-tag">
              <a href="javascript:;" id="mobile-tags">
                <span>标签</span>
                
                    <span class="menu-item-label">tags</span>
                
              </a>
            </div>
            <div class="mobile-nav-tagcloud">
              <div class="mobile-tagcloud-inner">
                <a href="/tags/Data-Structures/" style="font-size: 14px;">Data Structures</a> <a href="/tags/Docker/" style="font-size: 14px;">Docker</a> <a href="/tags/Dubbo/" style="font-size: 14px;">Dubbo</a> <a href="/tags/GHPages/" style="font-size: 14px;">GHPages</a> <a href="/tags/IO/" style="font-size: 14px;">IO</a> <a href="/tags/JDK/" style="font-size: 14px;">JDK</a> <a href="/tags/JVM/" style="font-size: 14px;">JVM</a> <a href="/tags/Linux/" style="font-size: 14px;">Linux</a> <a href="/tags/MyBatis/" style="font-size: 14px;">MyBatis</a> <a href="/tags/MySQL/" style="font-size: 14px;">MySQL</a> <a href="/tags/Python/" style="font-size: 14px;">Python</a> <a href="/tags/Spring/" style="font-size: 14px;">Spring</a> <a href="/tags/Zookeeper/" style="font-size: 14px;">Zookeeper</a> <a href="/tags/book/" style="font-size: 14px;">book</a> <a href="/tags/code/" style="font-size: 14px;">code</a> <a href="/tags/emacs/" style="font-size: 14px;">emacs</a> <a href="/tags/es/" style="font-size: 14px;">es</a> <a href="/tags/git/" style="font-size: 14px;">git</a> <a href="/tags/github/" style="font-size: 14px;">github</a> <a href="/tags/idea/" style="font-size: 14px;">idea</a> <a href="/tags/jmeter/" style="font-size: 14px;">jmeter</a> <a href="/tags/mac/" style="font-size: 14px;">mac</a> <a href="/tags/monitor/" style="font-size: 14px;">monitor</a> <a href="/tags/server/" style="font-size: 14px;">server</a> <a href="/tags/walkup/" style="font-size: 14px;">walkup</a> <a href="/tags/分布式/" style="font-size: 14px;">分布式</a> <a href="/tags/工具/" style="font-size: 14px;">工具</a> <a href="/tags/并发/" style="font-size: 14px;">并发</a> <a href="/tags/旅游/" style="font-size: 14px;">旅游</a> <a href="/tags/汇编/" style="font-size: 14px;">汇编</a> <a href="/tags/监控/" style="font-size: 14px;">监控</a> <a href="/tags/编码/" style="font-size: 14px;">编码</a>
              </div>
            </div>
          </div>
        
      
        
            <div class="mobile-nav-item">
                <a href="/about">
                    <span>关于</span>
                    
                        <span class="menu-item-label">about</span>
                    
                </a>
            </div>
        
      
    </div>
  </div>
  <div class="mobile-header-nav">
    <div class="mobile-header-item" id="mobile-left">
      <div class="header-menu-item">
        <span class="header-menu-line"></span>
      </div>
    </div>
    <h1 class="mobile-header-title">
      <a href="/">贰白</a>
    </h1>
    <div class="mobile-header-item"></div>
  </div>
</div>
    <div class="container-inner">
      <main class="main" id="main">
        <div class="main-wrapper">
          
    
  
  <article class="
  post
   is_post 
  ">
    <header class="post-header">
      <div class="post-time syuanpi fadeInUpShort back-1">
        <div class="post-time-wrapper">
          <span>2019-08-04</span>
          
            
              <span class="post-category"><a href="/categories/es/">es</a></span>
            
          
          
            
              <aside class="post-tags syuanpi fadeInUpShort back-3">
              
                <a href="/tags/es/">es</a>
              
              </aside>
            
          
        </div>
      </div>
      <h1 class="post-title syuanpi fadeInUpShort back-2">
        
          Elasticsearch查询概述
        
      </h1>
    </header>
    <div class="post-content syuanpi fadeInUpShort back-3">
      
        <p>就会用多无聊，看点别的</p>
<a id="more"></a>
<p><img src="https://github.com/super2bai/super2bai.github.io/blob/master/images/ES_Query_Summary.png?raw=true" alt=""></p>
<h3 id="检索文档"><a href="#检索文档" class="headerlink" title="检索文档"></a>检索文档</h3><p><code>GET /blog/_doc/3?pretty</code></p>
<p>根据<code>index</code>、<code>type</code>、<code>id</code>搜索文档</p>
<blockquote>
<p>在任意的查询字符串增加<code>pretty</code>参数，美化输出，但<code>_source</code>字段不会被美化，结果会与输入保持一致。</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="string">"_index"</span> : <span class="string">"blog"</span>,</div><div class="line">  <span class="string">"_type"</span> : <span class="string">"_doc"</span>,</div><div class="line">  <span class="string">"_id"</span> : <span class="string">"3"</span>,</div><div class="line">  <span class="string">"_version"</span> : <span class="number">1</span>,</div><div class="line">  <span class="string">"_seq_no"</span> : <span class="number">2</span>,</div><div class="line">  <span class="string">"_primary_term"</span> : <span class="number">1</span>,</div><div class="line">  <span class="string">"found"</span> : <span class="literal">true</span>,</div><div class="line">  <span class="string">"_source"</span> : &#123;</div><div class="line">    <span class="string">"contect"</span> : <span class="number">3</span>,</div><div class="line">    <span class="string">"date"</span> : <span class="string">"2019-07-23"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="空搜索"><a href="#空搜索" class="headerlink" title="空搜索"></a>空搜索</h3><p>没有指定任何查询条件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GET /_search</div></pre></td></tr></table></figure>
<p>返回集群中所有索引下的所有文章</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">	<span class="string">"took"</span>: <span class="number">4</span>,</div><div class="line">	<span class="string">"timed_out"</span>: <span class="literal">false</span>,</div><div class="line">	<span class="string">"_shards"</span>: &#123;</div><div class="line">		<span class="string">"total"</span>: <span class="number">1</span>,</div><div class="line">		<span class="string">"successful"</span>: <span class="number">1</span>,</div><div class="line">		<span class="string">"skipped"</span>: <span class="number">0</span>,</div><div class="line">		<span class="string">"failed"</span>: <span class="number">0</span></div><div class="line">	&#125;,</div><div class="line">	<span class="string">"hits"</span>: &#123;</div><div class="line">		<span class="string">"total"</span>: &#123;</div><div class="line">			<span class="string">"value"</span>: <span class="number">3</span>,</div><div class="line">			<span class="string">"relation"</span>: <span class="string">"eq"</span></div><div class="line">		&#125;,</div><div class="line">		<span class="string">"max_score"</span>: <span class="number">1.0</span>,</div><div class="line">		<span class="string">"hits"</span>: [&#123;</div><div class="line">			<span class="string">"_index"</span>: <span class="string">"blog"</span>,</div><div class="line">			<span class="string">"_type"</span>: <span class="string">"_doc"</span>,</div><div class="line">			<span class="string">"_id"</span>: <span class="string">"1"</span>,</div><div class="line">			<span class="string">"_score"</span>: <span class="number">1.0</span>,</div><div class="line">			<span class="string">"_source"</span>: &#123;</div><div class="line">				<span class="string">"contect"</span>: <span class="number">1</span>,</div><div class="line">				<span class="string">"date"</span>: <span class="string">"2019-07-21"</span></div><div class="line">			&#125;</div><div class="line">		&#125;]</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>took</strong>：执行整个搜索请求耗费的毫秒数</p>
<p><strong>timed_out</strong>：是否超时。如果响应时间比完成结果更重要，可以指定：<code>10ms</code>十毫秒或<code>1s</code>一秒。在超时之前，会返回已经从每个分片获取的结果。</p>
<blockquote>
<p>timeout不是停止执行查询，仅仅是告知正在协调的节点返回到目前为止收集的结果并且关闭连接。在后台，其他的分片可能仍在执行查询即使是结果已经被发送了。</p>
<p><strong>使用超时是因为SLA( 服务等级协议)是更重要的，而不是因为想去中止长时间运行的查询。</strong></p>
</blockquote>
<p><strong>_shards</strong>：查询中参与分片的总数，以及这些分片成功、失败的个数，被跳过的(跳过的原因？)</p>
<p><strong>hits</strong>：</p>
<p><code>total</code>：匹配到的文档总数，一个hits数组包含所查询结果的前十个文档</p>
<p><code>source</code>：可以直接从返回的结果中使用整个文档。不像其他的搜索引擎(其他的哪些?)，仅仅返回文档的ID，需要单独去获取文档</p>
<p><code>_score</code>：匹配度。文档按照_score降序排列。1是中性的</p>
<h3 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h3><p>当索引一个文档，它被存储在单独一个主分片上。Elasticsearch是如何知道文档属于哪个分片的呢？创建一个新文档时，它是如何知道是应该存储在分片1还是分片2上的呢？</p>
<p>进程不能是随机的，因为将来要检索文档。事实上，它根据一个简单的算法决定：</p>
<p><code>shard = hash(routing) % number_of_primary_shards</code></p>
<p><code>routing</code>：任意字符串，默认是<code>_id</code>，支持自定义。</p>
<ul>
<li>logstash中修改output中的routing值，es中不做修改。</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">output &#123;</div><div class="line">elasticsearch &#123;</div><div class="line">  hosts =&gt; "http://localhost:9200"</div><div class="line">  index =&gt; "movies"</div><div class="line">  document_id =&gt; "%&#123;id&#125;"</div><div class="line">  routing =&gt; "%&#123;category&#125; ###关键字</div><div class="line">&#125;</div><div class="line">stdout &#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>kibana查询时：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GET /movies/_search?routing=api ###routing指定是字段中具体的值</div></pre></td></tr></table></figure>
<ul>
<li>指定routing参数</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">POST /blog/_doc?routing=2019-01-04</div><div class="line">&#123;  </div><div class="line">&quot;contect&quot;:4,</div><div class="line">&quot;date&quot;:&quot;2019-01-04&quot;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>会按照日期将文档置于同一分片上</p>
<hr>
<p>其他：</p>
<ul>
<li>在所有索引中搜索：<code>/_search</code></li>
<li>在单索引搜索：<code>/blog/_search</code></li>
<li>在多索引中搜索：<code>/blog,movie/_search</code></li>
<li>模糊搜索： <code>/b*/_search</code></li>
</ul>
<blockquote>
<p>搜索一个索引有5个主分片和5个索引各有一个分片事实上是一样的。</p>
</blockquote>
<h3 id="document模型设计"><a href="#document模型设计" class="headerlink" title="document模型设计"></a>document模型设计</h3><p>对于MySQL，尽量避免一些复杂查询，在Elasticsearch中，应同样避免复杂查询，会影响性能。</p>
<p>对于计算的部分，在应用中完成，将计算后的数据直接写入es中。搜索的时候，就不需要利用es的搜索语法来完成复杂查询，比如 join/nested/parent-child 搜索都要尽量避免，性能都很差的。</p>
<h3 id="分页"><a href="#分页" class="headerlink" title="分页"></a>分页</h3><p>如果想看第11个文档，怎么办？</p>
<p>和SQL使用<code>LIMIT</code>关键字返回只有一页的结果一样，Elasticsearch接受<code>from</code>和<code>size</code>参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">size: 结果数，默认10</div><div class="line">from: 跳过开始的结果数，默认0</div></pre></td></tr></table></figure>
<p>如果想每页显示5个结果，页码从1到3，那请求如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">GET /_search?size=5</div><div class="line">GET /_search?size=5&amp;from=5</div><div class="line">GET /_search?size=5&amp;from=10</div></pre></td></tr></table></figure>
<p>应该当心分页太深或者一次请求太多的结果。结果在返回前会被排序。但是记住一个搜索请求常常涉及多个分片。每个分片生成自己排好序的结果，它们接着需要集中起来排序以确保整体排序正确。</p>
<p>假如每页10条数据，查询第100页，实际上是会把每个 shard 上存储的前 <code>1000</code> 条数据都查到一个协调节点上，如果你有个 5 个shard，那么就有 5000 条数据，接着协调节点对这 5000 条数据进行一些合并、处理，再获取到最终第 100 页的 10 条数据。</p>
<p>分布式的，你要查第100页的10条数据，不可能说从5个 shard，每个 shard 就查 2 条数据？最后到协调节点合并成 10 条数据？你必须得从每个 shard 都查 1000 条数据过来，然后根据你的需求进行排序、筛选等等操作，最后再次分页，拿到里面第 100 页的数据。你翻页的时候，翻的越深，每个 shard 返回的数据就越多，而且协调节点处理的时间越长。非常坑爹。所以用 es 做分页的时候，你会发现越翻到后面，就越是慢。</p>
<p>我们之前也是遇到过这个问题，用 es 作分页，前几页就几十毫秒，翻到 10 页或者几十页的时候，基本上就要 5~10秒 才能查出来一页数据了。</p>
<blockquote>
<h3 id="在集群系统中深度分页"><a href="#在集群系统中深度分页" class="headerlink" title="在集群系统中深度分页"></a>在集群系统中深度分页</h3><p>为了理解为什么深度分页是有问题的，让我们假设在一个有5个主分片的索引中搜索。当我们请求结果的第一页（结果1到10）时，每个分片产生自己最顶端10个结果然后返回它们给<strong>请求节点(requesting node)</strong>，它再排序这所有的50个结果以选出顶端的10个结果。</p>
<p>现在假设我们请求第1000页——结果10001到10010。工作方式都相同，不同的是每个分片都必须产生顶端的10010个结果。然后请求节点排序这50050个结果并丢弃50040个！</p>
<p>可以看到在分布式系统中，排序结果的花费随着分页的深入而成倍增长。这也是为什么网络搜索引擎中任何语句不能返回多于1000个结果的原因。</p>
</blockquote>
<p><img src="https://upload-images.jianshu.io/upload_images/10115652-df97de55bce2cebf.png?imageMogr2/auto-orient/" alt="img"></p>
<ul>
<li><code>filesystem cache</code></li>
</ul>
<blockquote>
<p>es 的搜索引擎严重依赖于底层的 <code>filesystem cache</code>，你如果给 <code>filesystem cache</code> 更多的内存，尽量让内存可以容纳所有的 <code>idx segment file</code> 索引数据文件，那么你搜索的时候就基本都是走内存的，性能会非常高。</p>
</blockquote>
<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.3/_pre_loading_data_into_the_file_system_cache.html" target="_blank" rel="external">数据预热</a></li>
</ul>
<blockquote>
<p>把一些热点数据，提前访问刷到<code>filesystem cache</code>，再次搜索时，直接走内存。 </p>
</blockquote>
<ul>
<li>冷热分离</li>
</ul>
<blockquote>
<p>冷数据写入一个索引中，热数据写入另外一个索引中，这样可以确保热数据在被预热后，尽量都留在<code>filesystem cache</code>中，别让冷数据给冲刷掉。</p>
</blockquote>
<hr>
<p>es建索引写入数据，数据最先是存在内存buffer里的，然后再刷入到lucene的底层文件segment中；<br>写入segment完毕后再执行refresh操作，refresh操作后，数据将commit到磁盘中。<br>数据刷入到了磁盘，就可以执行查询操作了。</p>
<p>过程简单描述如下：内存buffer–&gt;segment–&gt;refresh–&gt;磁盘</p>
<p>注意，这些过程，会有translog记录；translog存在的意义就是保证数据刷入的可靠性；<br>es建索引写入数据的过程是内存到磁盘的过程，这个过程有日志的记录，<br>那就是translog，当数据还在内存里没刷到磁盘中时，如果服务器down了又没translog机制的话，<br>那么数据就会丢失，有了translog，服务器down机后再起来，就能很快恢复写入的过程。</p>
<p>这里要注意的是，translog也是先存在内存里的，然后默认5秒刷一次写到硬盘里。</p>
<p><a href="https://www.jianshu.com/p/fa510352ce1a" target="_blank" rel="external">那么如何高效的检索大量文档？</a></p>

      
    
    </div>
    
      
  <div class="post-reward">
    <span class="reward-btn" id="reward-btn">点这里</span>
    <div class="reward-wrapper syuanpi" id="reward-wrapper" style="display:none;">
      
      <div class="reward-item reward-alipay">
        <img src="https://wx3.sinaimg.cn/mw690/8c564d2aly1ftkt83thjlj20o60skjzn.jpg">
      </div>
      
    </div>
  </div>


      
    
  </article>
  
    
  <nav class="article-page">
    
      <a href="/MySQL/intro.html" id="art-left" class="art-left">
        <span class="next-title">
          <i class="iconfont icon-left"></i>MySQL概述
        </span>
      </a>
    
    
      <a href="/prometheus/intro.html" id="art-right" class="art-right">
        <span class="prev-title"> 
          Prometheus介绍<i class="iconfont icon-right"></i>  
        </span>
      </a>
    
  </nav>

    
  <i id="com-switch" class="iconfont icon-more jumping-in long infinite" style="font-size:24px;display:block;text-align:center;transform:rotate(180deg);"></i>
  <div class="post-comments" id="post-comments" style="display: block;margin: auto 16px;">
    
<!-- Gitment Comments -->
<div id="gitment"></div>
<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<script>
var gitment = new Gitment({
  owner: "super2bai",
  repo: 'comment',
  oauth: {
    client_id: '37f2293730b41dcb5276',
    client_secret: 'dbab4955840d4cbc88f1563be04ab676662194e5',
  },
})
gitment.render('gitment')
</script>

    
    

  </div>


  
  
    
  
  <aside class="post-toc">
    <span class="title" id="toc-switch"><span>文章导航</span></span>
    <div class="toc-inner syuanpi back-1" style="display:none;">
      <li class="title-link"><a href="javascript:;" class="toTop">Elasticsearch查询概述</a></li>
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#检索文档"><span class="toc-text">检索文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#空搜索"><span class="toc-text">空搜索</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#路由"><span class="toc-text">路由</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#document模型设计"><span class="toc-text">document模型设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分页"><span class="toc-text">分页</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#在集群系统中深度分页"><span class="toc-text">在集群系统中深度分页</span></a></li></ol>
    </div>
  </aside>



  


        </div>
      </main>

      <footer class="footer syuanpi fadeIn" id="footer">
  <hr>
  <div class="footer-wrapper">
    <div class="left">
      <div class="contact-icon">
    
    
    
    
    
    
    
    
        
            <a href="https://github.com/super2bai" class="iconfont icon-github" title="github"></a>
        
        
        
        
        
        
        
    
</div>
    </div>
    <div class="right">
      <div class="copyright">
    <div class="info">
        <span>&copy;</span>
        <span>2017 ~ 2019</span>
        <span>❤</span>
        <span>super2bai</span>
    </div>
    <div class="theme">
        <span>
            动力来源于
            <a href="http://hexo.io/" target="_blank">Hexo </a>
        </span>
        <span>
            主题
            <a href="https://github.com/ColMugX/hexo-theme-Nlvi"> Nlvi </a>
        </span>
    </div>
    
    <div class="visit_count">
        <i class="iconfont icon-visit"></i>
        <span id="busuanzi_value_site_uv"></span>
        <i class="iconfont icon-people"></i>
        <span id="busuanzi_value_site_pv"></span>
    </div>
    
</div>

    </div>
  </div>
</footer>
    </div>
  </div>
  <script src="/script/lib/jquery/jquery-3.2.1.min.js"></script>


  <script src="/script/lib/lightbox/js/lightbox.min.js"></script>








<script src="/script/src/nlvi.js"></script>

  <script src="/script/scheme/banderole.js"></script>

<script src="/script/bootstarp.js"></script>


<div class="backtop syuanpi melt toTop" id="backtop">
    <i class="iconfont icon-up"></i>
    <span style="text-align:center;font-family:Georgia;"><span style="font-family:Georgia;" id="scrollpercent">1</span>%</span>
</div>


  <div class="search" id="search">
    <div class="mask" id="mask"></div>
    <div class="search-wrapper syuanpi">
      <h2 id="search-header" class="syuanpi">找啥？</h2>
      <div class="input">
        <input type="text" id="local-search-input" results="0" name="">
      </div>
      <div id="local-search-result"></div>
    </div>
  </div>


</body>
</html>
