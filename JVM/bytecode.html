<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <link rel="stylesheet" href="/style/style.css">
<script>
  var nlviconfig = {
    title: "贰白",
    author: "super2bai",
    baseUrl: "/",
    theme: {
      scheme: "banderole",
      lightbox: true,
      animate: true,
      search: false,
      friends: false,
      reward: true,
      lazy: false
    }
  }
</script>




    <link rel="stylesheet" href="/script/lib/lightbox/css/lightbox.min.css">




    <link rel="stylesheet" href="/syuanpi/syuanpi.min.css">




    <link rel="icon" href="https://wx4.sinaimg.cn/mw690/8c564d2agy1fq4rsiycy4j202c01wa9v.jpg">




<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-98059014-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-116557847-1');
</script>





    <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="browsermode" content="application">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="贰白">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="msapplication-navbutton-color" content="#666666">
<meta name= "format-detection" content="telephone=no" />
<meta name="keywords" content="nlvi, Nlvi" />

  <link rel="apple-touch-icon"  sizes="72x72"  href="https://wx4.sinaimg.cn/mw690/8c564d2agy1fq4rsiycy4j202c01wa9v.jpg">
  <link rel="apple-touch-icon-precomposed"  sizes="72x72"  href="https://wx4.sinaimg.cn/mw690/8c564d2agy1fq4rsiycy4j202c01wa9v.jpg">


  <meta name="subtitle" content="苦于探索，全是未知">


  <meta name="description" content="苦于探索，全是未知">



  <meta name="keywords" content="JVM, Nlvi" />

  <title> 字节码指令 · 贰白 </title>
</head>
<body>
  <div class="progress">
  <div class="progress-inner"></div>
</div>
  
  
    <div class="tagcloud-mask"></div>  
<div class="tagcloud" id="tagcloud">
  <div class="tagcloud-inner">
    <a href="/tags/Data-Structures/" style="font-size: 14px;">Data Structures</a> <a href="/tags/Docker/" style="font-size: 14px;">Docker</a> <a href="/tags/Dubbo/" style="font-size: 14px;">Dubbo</a> <a href="/tags/GHPages/" style="font-size: 14px;">GHPages</a> <a href="/tags/IO/" style="font-size: 14px;">IO</a> <a href="/tags/JDK/" style="font-size: 14px;">JDK</a> <a href="/tags/JVM/" style="font-size: 14px;">JVM</a> <a href="/tags/Linux/" style="font-size: 14px;">Linux</a> <a href="/tags/MySQL/" style="font-size: 14px;">MySQL</a> <a href="/tags/Python/" style="font-size: 14px;">Python</a> <a href="/tags/Spring/" style="font-size: 14px;">Spring</a> <a href="/tags/Zookeeper/" style="font-size: 14px;">Zookeeper</a> <a href="/tags/code/" style="font-size: 14px;">code</a> <a href="/tags/git/" style="font-size: 14px;">git</a> <a href="/tags/jmeter/" style="font-size: 14px;">jmeter</a> <a href="/tags/mac/" style="font-size: 14px;">mac</a> <a href="/tags/monitor/" style="font-size: 14px;">monitor</a> <a href="/tags/walkup/" style="font-size: 14px;">walkup</a> <a href="/tags/分布式/" style="font-size: 14px;">分布式</a> <a href="/tags/工具/" style="font-size: 14px;">工具</a> <a href="/tags/并发/" style="font-size: 14px;">并发</a> <a href="/tags/旅游/" style="font-size: 14px;">旅游</a> <a href="/tags/汇编/" style="font-size: 14px;">汇编</a> <a href="/tags/编码/" style="font-size: 14px;">编码</a>
  </div>
</div>  
  

  <div class="container">

    <header class="header" id="header">
  <div class="header-wrapper">
    <div class="logo">
  <div class="logo-inner syuanpi tvIn">
    <span><a href="/">贰白</a></span>
    
      <span id="subtitle">苦于探索，全是未知</span>
    
  </div>
</div>
    <nav class="main-nav">
  
  <ul class="main-nav-list syuanpi tvIn">
  
  
    
      
    
    <li class="menu-item">
      <a href="/" id="article">
        <span class="base-name">文章</span>
        
          <span class="menu-item-label">article</span>
        
      </a>
    </li>
  
    
      
    
    <li class="menu-item">
      <a href="/archives" id="archives">
        <span class="base-name">归档</span>
        
          <span class="menu-item-label">archives</span>
        
      </a>
    </li>
  
    
      
    
    <li class="menu-item">
      <a href="javascript:;" id="tags">
        <span class="base-name">标签</span>
        
          <span class="menu-item-label">tags</span>
        
      </a>
    </li>
  
    
      
    
    <li class="menu-item">
      <a href="/about" id="about">
        <span class="base-name">关于</span>
        
          <span class="menu-item-label">about</span>
        
      </a>
    </li>
  
  </ul>
  
</nav>

    
    
  </div>
</header>
<div class="mobile-header">
  <div class="mobile-header-body">
    <div class="mobile-header-list">
      
        
            <div class="mobile-nav-item">
                <a href="/">
                    <span>文章</span>
                    
                        <span class="menu-item-label">article</span>
                    
                </a>
            </div>
        
      
        
            <div class="mobile-nav-item">
                <a href="/archives">
                    <span>归档</span>
                    
                        <span class="menu-item-label">archives</span>
                    
                </a>
            </div>
        
      
        
          <div class="mobile-nav-item inner-cloud">
            <div class="mobile-nav-tag">
              <a href="javascript:;" id="mobile-tags">
                <span>标签</span>
                
                    <span class="menu-item-label">tags</span>
                
              </a>
            </div>
            <div class="mobile-nav-tagcloud">
              <div class="mobile-tagcloud-inner">
                <a href="/tags/Data-Structures/" style="font-size: 14px;">Data Structures</a> <a href="/tags/Docker/" style="font-size: 14px;">Docker</a> <a href="/tags/Dubbo/" style="font-size: 14px;">Dubbo</a> <a href="/tags/GHPages/" style="font-size: 14px;">GHPages</a> <a href="/tags/IO/" style="font-size: 14px;">IO</a> <a href="/tags/JDK/" style="font-size: 14px;">JDK</a> <a href="/tags/JVM/" style="font-size: 14px;">JVM</a> <a href="/tags/Linux/" style="font-size: 14px;">Linux</a> <a href="/tags/MySQL/" style="font-size: 14px;">MySQL</a> <a href="/tags/Python/" style="font-size: 14px;">Python</a> <a href="/tags/Spring/" style="font-size: 14px;">Spring</a> <a href="/tags/Zookeeper/" style="font-size: 14px;">Zookeeper</a> <a href="/tags/code/" style="font-size: 14px;">code</a> <a href="/tags/git/" style="font-size: 14px;">git</a> <a href="/tags/jmeter/" style="font-size: 14px;">jmeter</a> <a href="/tags/mac/" style="font-size: 14px;">mac</a> <a href="/tags/monitor/" style="font-size: 14px;">monitor</a> <a href="/tags/walkup/" style="font-size: 14px;">walkup</a> <a href="/tags/分布式/" style="font-size: 14px;">分布式</a> <a href="/tags/工具/" style="font-size: 14px;">工具</a> <a href="/tags/并发/" style="font-size: 14px;">并发</a> <a href="/tags/旅游/" style="font-size: 14px;">旅游</a> <a href="/tags/汇编/" style="font-size: 14px;">汇编</a> <a href="/tags/编码/" style="font-size: 14px;">编码</a>
              </div>
            </div>
          </div>
        
      
        
            <div class="mobile-nav-item">
                <a href="/about">
                    <span>关于</span>
                    
                        <span class="menu-item-label">about</span>
                    
                </a>
            </div>
        
      
    </div>
  </div>
  <div class="mobile-header-nav">
    <div class="mobile-header-item" id="mobile-left">
      <div class="header-menu-item">
        <span class="header-menu-line"></span>
      </div>
    </div>
    <h1 class="mobile-header-title">
      <a href="/">贰白</a>
    </h1>
    <div class="mobile-header-item"></div>
  </div>
</div>
    <div class="container-inner">
      <main class="main" id="main">
        <div class="main-wrapper">
          
    
  
  <article class="
  post
   is_post 
  ">
    <header class="post-header">
      <div class="post-time syuanpi fadeInUpShort back-1">
        <div class="post-time-wrapper">
          <span>2018-09-17</span>
          
            
              <span class="post-category"><a href="/categories/JVM/">JVM</a></span>
            
          
          
            
              <aside class="post-tags syuanpi fadeInUpShort back-3">
              
                <a href="/tags/JVM/">JVM</a>
              
              </aside>
            
          
        </div>
      </div>
      <h1 class="post-title syuanpi fadeInUpShort back-2">
        
          字节码指令
        
      </h1>
    </header>
    <div class="post-content syuanpi fadeInUpShort back-3">
      
        <p>能直接阅读字节码时工作中分析Java代码语义问题的基本技能</p>
<a id="more"></a>
<h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><blockquote>
<ul>
<li>JVM指令的构成<ul>
<li><strong>一个字节长度</strong><ul>
<li>0x00~0xFF,0~255</li>
</ul>
</li>
<li><strong>代表某种特定操作含义的数字(操作码,Opcode)</strong></li>
<li><strong>零到多个代表次操作所需参数(操作数,Operands)</strong>。</li>
</ul>
</li>
<li>架构：面向操作数栈<del>不是寄存器</del></li>
<li>特点：<ul>
<li>大多数指令都不包含操作数，只有一个操作码</li>
<li>非完全独立(Not Orthogonal)<ul>
<li>并非每种数据类型和每一种操作都有对应的指令</li>
</ul>
</li>
</ul>
</li>
</ul>
</blockquote>
<ul>
<li>JVM处理超过一个字节数据的时候，会在运行时从字节中重建出具体数据的结构<ul>
<li>原因<ul>
<li>指令长度为1字节</li>
<li>Class文件格式放弃了编译后代码的操作数长度对其</li>
</ul>
</li>
<li>优点<ul>
<li>省略填充和建个符号</li>
<li>编译代码短</li>
</ul>
</li>
<li>缺点</li>
<li>解释执行字节码时损失一些性能</li>
</ul>
</li>
</ul>
<h3 id="字节码与数据类型"><a href="#字节码与数据类型" class="headerlink" title="字节码与数据类型"></a>字节码与数据类型</h3><ul>
<li>对于大部分与基本数据类型(int、long、short、byte、char、float、double)相关的字节码指令，操作码助记符在首位会以数据类型首字母开头</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">iload：从局部变量表中加载int型的数据到操作数栈中</div><div class="line">fload：从局部变量表中加载float型的数据到操作数栈中</div></pre></td></tr></table></figure>
<ul>
<li>a代表reference</li>
<li>大部分指令都没有支持整数类型(byte、char和short)，没有任何指令支持boolean<ul>
<li>编译器会将byte和short类型数据<strong>带符号扩展(Sign-Extend)</strong>为相应的int类型数据</li>
<li>将boolean和char类型数据<strong>零位扩展(Zero-Extend)</strong>为相应的int类型数据</li>
</ul>
</li>
</ul>
<h3 id="加载和存储指令"><a href="#加载和存储指令" class="headerlink" title="加载和存储指令"></a>加载和存储指令</h3><ul>
<li>作用<ul>
<li>将数据在栈帧只能够的局部变量表和操作数栈之间来回传输</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//将一个局部变量加载到操作数栈：</span></div><div class="line">*load&lt;_n&gt;：iload、iload_3</div><div class="line"><span class="comment">//将一个数值从操作数栈存储到局部变量表</span></div><div class="line">*store&lt;_n&gt;：astore、astore_2</div><div class="line"><span class="comment">//将一个常量加载到操作数栈</span></div><div class="line">bipush、sipush、idc、idc_w、idc2_w、aconst_null、iconst_m1、iconst_&lt;i&gt;、lconst_&lt;l&gt;、fconst_&lt;f&gt;、dconst_&lt;d&gt;</div><div class="line"><span class="comment">//扩充局部变量表的访问索引</span></div><div class="line">wide</div></pre></td></tr></table></figure>
<h3 id="运算指令"><a href="#运算指令" class="headerlink" title="运算指令"></a>运算指令</h3><ul>
<li>作用<ul>
<li>对两个操作数栈上的值进行某种特定运算，并把结果重新存入到操作栈顶</li>
</ul>
</li>
<li>分类<ul>
<li>对整型数据进行运算</li>
<li>对浮点型数据进行运算</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//加法</span></div><div class="line">*add：iadd、ladd、fadd、dadd</div><div class="line"><span class="comment">//减法</span></div><div class="line">*sub：isub、lsub、fsub、dsub</div><div class="line"><span class="comment">//乘法</span></div><div class="line">*mul：imul、lmul、fmul、dmul</div><div class="line"><span class="comment">//除法</span></div><div class="line">*div：idiv、ldiv、fdiv、ddiv</div><div class="line"><span class="comment">//求余</span></div><div class="line">*rem：irem、lrem、frem、drem</div><div class="line"><span class="comment">//取反</span></div><div class="line">*neg：ineg、lneg、fneg、dneg</div><div class="line"><span class="comment">//位移</span></div><div class="line">ishl、ishr、iushr、lshl、lshr、lushr</div><div class="line"><span class="comment">//按位或</span></div><div class="line">ior、lor</div><div class="line"><span class="comment">//按位与</span></div><div class="line">iand、land</div><div class="line"><span class="comment">//按位异或</span></div><div class="line">ixor、lxor</div><div class="line"><span class="comment">//局部变量自增</span></div><div class="line">iinc</div><div class="line"><span class="comment">//比较</span></div><div class="line">dcmpg、dcmpl、fcmpg、fcmpl、lcmp</div></pre></td></tr></table></figure>
<ul>
<li>两个int值相加结果超过int范围，将会返回负数</li>
<li>JVM规范没有明确定义过整型数据溢出的具体运算结果，仅规定了在处理整型数据时，只有<strong>除法指令(idiv和ldiv)</strong>以及<strong>求余指令(irem和lrem)</strong> 中当出现<strong>除数为零</strong>时会导致虚拟机抛出<strong><code>ArithmeticException</code></strong>异常，其余任何整型数运算场景都不应抛出运行时异常。</li>
<li>JVM规范要求JVM必须完全支持 <a href="https://zh.wikipedia.org/wiki/IEEE_754" target="_blank" rel="external">IEEE 754</a>中定义的非规约形式的浮点数值(Denormalized Floating-Point Numbers)和逐级下溢(Gradual Underflow)的运算规则。<ul>
<li>对于浮点数，当最小值超过范围的时候，会逐级下溢；当最大值超过范围的时候，会发生上溢。</li>
</ul>
</li>
</ul>
<blockquote>
<p>如果浮点数的指数部分的编码值是0，分数部分非零，那么这个浮点数将被称为<strong>非规约形式的浮点数</strong>。一般是某个数字<strong>相当</strong>接近零时才会使用非规约型式来表示。 IEEE 754标准规定：<strong>非规约形式的浮点数的指数偏移值比规约形式的浮点数的指数偏移值小1</strong>。</p>
</blockquote>
<ul>
<li>浮点数运算时，默认的舍入模式为向最接近数的精确值，优先选择最低有效位位零的。</li>
<li>浮点数转整数的时候采用的时向零舍入，即直接将小数位舍掉。</li>
<li>如果计算的结果没有明确定义，不抛异常，返回<code>NaN</code>。</li>
<li>对于long类型数值比较时，采用带符号的比较方式；对于浮点数(dcmpg、dcmpl、fcmpg、fcmpl)采用无信号比较方式。</li>
</ul>
<h3 id="类型转换指令"><a href="#类型转换指令" class="headerlink" title="类型转换指令"></a>类型转换指令</h3><p>JVM支持隐式宽化转换(Widening Numberic Conversions，小范围类型向大范围类型的安全转换)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">int  -&gt; long、float、double</div><div class="line">long -&gt; float、double</div><div class="line">float-&gt; double</div></pre></td></tr></table></figure>
<p>必须显式使用转换指令处理窄化类型转换(Narrowing Numeric Conversions)。导致转换结果产生不同的正负号(符号在高位)、数量级，导致精度丢失。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">i2b、i2c、i2s、l2i、f2i、f2l、d2i、d2l、d2f</div></pre></td></tr></table></figure>
<ul>
<li>将int或long类型窄化转换为类型T的时候，将丢弃除最低位数据类型长度字节以外的内容。</li>
<li>浮点值窄化为int或long规则<ul>
<li>浮点值为<code>NaN</code>，返回int或long的0</li>
<li>浮点值不是无穷大，采用向零舍入模式取整，符合范围则返回，否则根据结果值的符号，转换为目标类型可表示的最大或最小整数。</li>
</ul>
</li>
<li>double&gt;float<ul>
<li>最接近数摄入模式</li>
<li>绝对值太小则返回float类型的正负零</li>
<li>太大则返回float类型的正负无穷大</li>
<li>double的NaN返回float的NaN</li>
</ul>
</li>
<li>永远不会抛异常</li>
</ul>
<h3 id="对象创建与访问指令"><a href="#对象创建与访问指令" class="headerlink" title="对象创建与访问指令"></a>对象创建与访问指令</h3><p>类实例和数组的创建和使用采用不同的字节码指令。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/****************类*******************/</span></div><div class="line"><span class="comment">//创建类实例</span></div><div class="line"><span class="keyword">new</span></div><div class="line"><span class="comment">//访问类字段(static)和实例字段(非static)</span></div><div class="line">getfield、putfield、getstatic、putstatic</div><div class="line"><span class="comment">//检查类实例类型</span></div><div class="line"><span class="keyword">instanceof</span>、checkcast</div><div class="line"><span class="comment">/****************数组*******************/</span></div><div class="line"><span class="comment">//创建数组</span></div><div class="line">newarray、anewarray、nultianewarray    </div><div class="line"><span class="comment">//把一个数组元素加载到操作数栈</span></div><div class="line">baload、caload、saload、iaload、laload、faload、daload、aaload</div><div class="line"><span class="comment">//把一个操作数栈的值存储到数组元素中</span></div><div class="line">bastore、castore、sastore、iastore、fastore、dastore、aastore</div><div class="line"><span class="comment">//获取数组长度</span></div><div class="line">arraylength</div></pre></td></tr></table></figure>
<h3 id="操作数栈管理指令"><a href="#操作数栈管理指令" class="headerlink" title="操作数栈管理指令"></a>操作数栈管理指令</h3><p>JVM提供一些用于直接操作操作数栈的指令。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//栈顶一个或两个元素出栈</span></div><div class="line">pop、pop2</div><div class="line"><span class="comment">//复制栈顶一个或两个数值，并将复制值或双份复制值重新压入栈顶</span></div><div class="line">dup、dup2、dup_x1、dup_x2、dup2_1、dup2_x2</div><div class="line"><span class="comment">//栈顶的两个数值互换</span></div><div class="line">swap</div></pre></td></tr></table></figure>
<h3 id="控制转移指令"><a href="#控制转移指令" class="headerlink" title="控制转移指令"></a>控制转移指令</h3><p>可以让JVM从指定位置(而不是控制转移指令的下一条指令)继续执行程序，从概念模型上可以认为是修改PC寄存器的值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//条件分支</span></div><div class="line">ifeq、iflt、ifle、ifne、ifgt、ifge、ifnull、ifnonnull、if_icmpeq、if_icmpne、if_icmplt、if_icmpgt、if_icmple、if_icmpge、if_acmpeq、if_acmpne</div><div class="line"><span class="comment">//复合条件分支</span></div><div class="line">tableswitch、lookupswitch</div><div class="line"><span class="comment">//无条件分支</span></div><div class="line">goto、goto_w、jsr、jsr_w、ret</div></pre></td></tr></table></figure>
<ul>
<li>对于boolean、byte、char、short类型是通过int类型的比较指令完成</li>
<li>对于long、float、double类型，先执行对应类型的指令，运算指令会返回一个整型值到操作数栈中，再执行int类型的条件分支比较操作来完整整个分支跳转。</li>
</ul>
<h3 id="方法调用和返回指令"><a href="#方法调用和返回指令" class="headerlink" title="方法调用和返回指令"></a>方法调用和返回指令</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*****************分派逻辑固化在JVM内部*****************/</span></div><div class="line"><span class="comment">//调用对象的实例方法，根据对象的实际类型进行分派(虚方法分派、Java中最常见的分派方式)</span></div><div class="line">invokevirtual</div><div class="line"><span class="comment">//调用接口方法，它会在运行时搜索一个实现了这个接口方法的对象，找出适合的方法进行调用</span></div><div class="line">invokeinterface</div><div class="line"><span class="comment">//调用需要特殊处理的实例方法，如：实例初始化方法、私有方法、父类指令</span></div><div class="line">invokespecial</div><div class="line"><span class="comment">//调用类方法(static method)</span></div><div class="line">invokestatic</div><div class="line"><span class="comment">/********分派逻辑是由用户所设定的引导方法决定的********/</span></div><div class="line"><span class="comment">//在运行时动态解析出调用点限定符所引用的方法，并执行</span></div><div class="line">invokedynamic</div></pre></td></tr></table></figure>
<p>方法<strong>调用指令</strong>与数据类型无关，方法<strong>返回指令</strong>是根据返回值的类型区分的。</p>
<h3 id="异常处理指令"><a href="#异常处理指令" class="headerlink" title="异常处理指令"></a>异常处理指令</h3><p>Java程序中显示抛出异常(<code>throw</code>)由<code>athrow</code>指令完成，而处理异常(catch语句)不是由字节码指令来完成的(取消了<code>jsr</code>和<code>ret</code>指令，采用<strong>异常表</strong>来完成)。</p>
<h3 id="同步指令"><a href="#同步指令" class="headerlink" title="同步指令"></a>同步指令</h3><p>JVM支持<strong>方法级的同步</strong>和<strong>方法内部一段指令序列的同步</strong>。都是由<code>Monitor</code>管程支持的。</p>
<h4 id="方法级同步"><a href="#方法级同步" class="headerlink" title="方法级同步"></a>方法级同步</h4><blockquote>
<p>方法级的同步是隐式的，无需通过字节码指令来控制，实现在方法调用和返回操作之中。JVM可以从方法常量池的方法表结构中的<code>ACC_SYCHRONIZED</code>访问标识得知一个方法是否为同步方法。</p>
</blockquote>
<ul>
<li>方法调用，检查方法的<code>ACC_SYCHRONIZED</code>访问标志是否设置，如果有<ul>
<li>执行线程就要求先成功持有管程(其他任何线程都无法再获得同一管程)</li>
<li>执行方法</li>
<li>执行完毕<ul>
<li>没有抛出异常，释放管程</li>
<li>抛出异常，并且在方法内部无法处理此异常，则在异常抛到同步方法之外时自动释放管程</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="指令序列同步"><a href="#指令序列同步" class="headerlink" title="指令序列同步"></a>指令序列同步</h4><p>由Java语言中的<code>synchronized</code>语句块表示，由<code>monitorenter(开始同步)</code>和<code>monitorexit(退出同步)</code>两条指令来支持。</p>
<p>正确实现synchronized关键字需要Javac编译器与JVM两者共同协作支持。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">onlyMe</span><span class="params">(Foo f)</span></span>&#123;</div><div class="line">		<span class="keyword">synchronized</span>(f)&#123;</div><div class="line">			doSomething();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="class"><span class="keyword">class</span> <span class="title">Foo</span></span>&#123;</div><div class="line"></div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">doSomething</span><span class="params">()</span></span>&#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>javac Test.java</code></li>
<li><code>javap -v Test</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">onlyMe</span><span class="params">(Test$Foo)</span></span>;</div><div class="line">    descriptor: (LTest$Foo;)V</div><div class="line">    flags: (<span class="number">0x0000</span>)</div><div class="line">    Code:</div><div class="line">      stack=<span class="number">2</span>, locals=<span class="number">4</span>, args_size=<span class="number">2</span></div><div class="line">         <span class="number">0</span>: aload_1							<span class="comment">//将对象f入栈</span></div><div class="line">         <span class="number">1</span>: dup								<span class="comment">//复制栈顶元素(f的引用)</span></div><div class="line">         <span class="number">2</span>: astore_2						<span class="comment">//将栈顶元素存储到局部变量表Slot 2中</span></div><div class="line">         <span class="number">3</span>: monitorenter					<span class="comment">//以栈顶元素(f)作为锁，开始同步</span></div><div class="line">         <span class="number">4</span>: aload_0							<span class="comment">//将局部变量Slot 0(this)的元素入栈</span></div><div class="line">         5: invokevirtual #2                //调用doSomething方法</div><div class="line">         <span class="number">8</span>: aload_2							<span class="comment">//将局部变量Slot 2元素(f)入栈</span></div><div class="line">         <span class="number">9</span>: monitorexit						<span class="comment">//退出同步</span></div><div class="line">        <span class="number">10</span>: goto          <span class="number">18</span>				<span class="comment">//方法正常结束，跳转到18返回</span></div><div class="line">        <span class="number">13</span>: astore_3						<span class="comment">//异常路径，见下面异常表的Target13</span></div><div class="line">        <span class="number">14</span>: aload_2							<span class="comment">//将局部变量Slot 2元素(f)入栈</span></div><div class="line">        <span class="number">15</span>: monitorexit						<span class="comment">//退出同步</span></div><div class="line">        <span class="number">16</span>: aload_3							<span class="comment">//将局部变量Slot 3元素(异常对象)入栈</span></div><div class="line">        <span class="number">17</span>: athrow							<span class="comment">//吧异常对象重新抛给onlyMe方法的调用者</span></div><div class="line">        <span class="number">18</span>: <span class="keyword">return</span>							<span class="comment">//方法正常返回</span></div><div class="line">      Exception table:</div><div class="line">         from    to  target type</div><div class="line">             <span class="number">4</span>    <span class="number">10</span>    <span class="number">13</span>   any</div><div class="line">            <span class="number">13</span>    <span class="number">16</span>    <span class="number">13</span>   any</div></pre></td></tr></table></figure>
<p>编译器必须确保无论方法通过何种方式完成，方法中调用过的每条monitorenter指令都必须执行其对应的monitorexit指令。</p>
<p>为了保证在方法异常完成时，monitorenter和monitorexit指令依旧可以正确配对执行，编译器会自动产生一个异常处理器，它可以处理所有异常，目的是为了执行monitorexit指令</p>
<hr>
<p>JVM规范推荐在满足规范的条件下对具体实现作出修改和优化。</p>
<p>JVM可以将输入JVM代码在加载和执行时翻译成两种不同的指令集</p>
<ul>
<li>另外一种虚拟机的指令集</li>
<li>宿主机CPU的本地指令集(<code>JIT</code>)</li>
</ul>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://docs.oracle.com/javase/specs/jvms/se10/jvms10.pdf" target="_blank" rel="external">JVM Specifications</a></p>

      
    
    </div>
    
      
  <div class="post-reward">
    <span class="reward-btn" id="reward-btn">点这里</span>
    <div class="reward-wrapper syuanpi" id="reward-wrapper" style="display:none;">
      
      <div class="reward-item reward-alipay">
        <img src="https://wx3.sinaimg.cn/mw690/8c564d2aly1ftkt83thjlj20o60skjzn.jpg">
      </div>
      
    </div>
  </div>


      
    
  </article>
  
    
  <nav class="article-page">
    
      <a href="/JVM/clzloadtime.html" id="art-left" class="art-left">
        <span class="next-title">
          <i class="iconfont icon-left"></i>虚拟机类加载时机
        </span>
      </a>
    
    
      <a href="/JVM/classDetail2.html" id="art-right" class="art-right">
        <span class="prev-title"> 
          Class文件详述(2)<i class="iconfont icon-right"></i>  
        </span>
      </a>
    
  </nav>

    
  <i id="com-switch" class="iconfont icon-more jumping-in long infinite" style="font-size:24px;display:block;text-align:center;transform:rotate(180deg);"></i>
  <div class="post-comments" id="post-comments" style="display: block;margin: auto 16px;">
    
<!-- Gitment Comments -->
<div id="gitment"></div>
<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<script>
var gitment = new Gitment({
  owner: "super2bai",
  repo: 'comment',
  oauth: {
    client_id: '37f2293730b41dcb5276',
    client_secret: 'dbab4955840d4cbc88f1563be04ab676662194e5',
  },
})
gitment.render('gitment')
</script>

    
    

  </div>


  
  
    
  
  <aside class="post-toc">
    <span class="title" id="toc-switch"><span>文章导航</span></span>
    <div class="toc-inner syuanpi back-1" style="display:none;">
      <li class="title-link"><a href="javascript:;" class="toTop">字节码指令</a></li>
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#概述"><span class="toc-text">概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#字节码与数据类型"><span class="toc-text">字节码与数据类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#加载和存储指令"><span class="toc-text">加载和存储指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#运算指令"><span class="toc-text">运算指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#类型转换指令"><span class="toc-text">类型转换指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#对象创建与访问指令"><span class="toc-text">对象创建与访问指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#操作数栈管理指令"><span class="toc-text">操作数栈管理指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#控制转移指令"><span class="toc-text">控制转移指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#方法调用和返回指令"><span class="toc-text">方法调用和返回指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#异常处理指令"><span class="toc-text">异常处理指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#同步指令"><span class="toc-text">同步指令</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#方法级同步"><span class="toc-text">方法级同步</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#指令序列同步"><span class="toc-text">指令序列同步</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#参考"><span class="toc-text">参考</span></a></li></ol>
    </div>
  </aside>



  


        </div>
      </main>

      <footer class="footer syuanpi fadeIn" id="footer">
  <hr>
  <div class="footer-wrapper">
    <div class="left">
      <div class="contact-icon">
    
    
    
    
    
    
    
    
        
            <a href="https://github.com/super2bai" class="iconfont icon-github" title="github"></a>
        
        
        
        
        
        
        
    
</div>
    </div>
    <div class="right">
      <div class="copyright">
    <div class="info">
        <span>&copy;</span>
        <span>2017 ~ 2019</span>
        <span>❤</span>
        <span>super2bai</span>
    </div>
    <div class="theme">
        <span>
            动力来源于
            <a href="http://hexo.io/" target="_blank">Hexo </a>
        </span>
        <span>
            主题
            <a href="https://github.com/ColMugX/hexo-theme-Nlvi"> Nlvi </a>
        </span>
    </div>
    
    <div class="visit_count">
        <i class="iconfont icon-visit"></i>
        <span id="busuanzi_value_site_uv"></span>
        <i class="iconfont icon-people"></i>
        <span id="busuanzi_value_site_pv"></span>
    </div>
    
</div>

    </div>
  </div>
</footer>
    </div>
  </div>
  <script src="/script/lib/jquery/jquery-3.2.1.min.js"></script>


  <script src="/script/lib/lightbox/js/lightbox.min.js"></script>








<script src="/script/src/nlvi.js"></script>

  <script src="/script/scheme/banderole.js"></script>

<script src="/script/bootstarp.js"></script>


<div class="backtop syuanpi melt toTop" id="backtop">
    <i class="iconfont icon-up"></i>
    <span style="text-align:center;font-family:Georgia;"><span style="font-family:Georgia;" id="scrollpercent">1</span>%</span>
</div>



</body>
</html>
