<!DOCTYPE html>
<html lang="">
<head>
    <title> HopSpot虚拟机对象探秘 · super2bai </title>
    <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="browsermode" content="application">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="super2bai">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="msapplication-navbutton-color" content="#666666">
<meta name= "format-detection" content="telephone=no" />
<meta name="keywords" content="nlvi, Nlvi" />





    <meta name="keywords" content="JVM, Nlvi" />

<link rel="stylesheet" href="/style/style.css">
<script src="/script/jquery.min.js"></script>
<script>
    var CONFIG = {
        title: "super2bai",
        author: "super2bai",
        lightbox: true,
        animate: true
    }
</script>



    <link rel="stylesheet" href="/lightbox/css/lightbox.min.css">




    <link rel="stylesheet" href="/syuanpi/syuanpi.min.css">









    <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>


</head>
<body>
    <div class="progress">
    <div class="progress-inner"></div>
</div>
    <div class="body">
    <div class="tagcloud-mask"></div>  
<div class="tagcloud" id="tagcloud">
    <div class="tagcloud-inner">
        <a href="/tags/Dubbo/" style="font-size: 14px;">Dubbo</a> <a href="/tags/GitHub-Pages/" style="font-size: 14px;">GitHub Pages</a> <a href="/tags/IO/" style="font-size: 14px;">IO</a> <a href="/tags/JVM/" style="font-size: 14px;">JVM</a> <a href="/tags/Spring/" style="font-size: 14px;">Spring</a> <a href="/tags/Zookeeper/" style="font-size: 14px;">Zookeeper</a> <a href="/tags/walkup/" style="font-size: 14px;">walkup</a> <a href="/tags/分布式/" style="font-size: 14px;">分布式</a>
    </div>
</div>
    <header class="header" id="header">
    <div class="title syuanpi tvIn">
    <div class="table">
        <div class="connect">
            <div class="connect-inner">
                <span><a href="/">super2bai</a></span>
                
            </div>
        </div>
    </div>
</div>
    <nav class="main-nav syuanpi tvIn">
<div class="table">

    <ul class="menu">
        
        
        
            <li class="menu-item">
                <a href="/">
                    <span>Article</span>
                    
                    
                </a>
            </li>
        
        
        
            <li class="menu-item">
                <a href="/archives">
                    <span>Archives</span>
                    
                    
                </a>
            </li>
        
        
        
            <li class="menu-item">
                <a href="javascript:;" id="tags">
                    <span>Tags</span>
                    
                    
                </a>
            </li>
        
        
        
            <li class="menu-item">
                <a href="/about">
                    <span>About</span>
                    
                    
                </a>
            </li>
        
        
    </ul>

</div>
</nav>
</header>
<div class="mobile-header">
    <div class="mobile-header-body">
        <div class="mobile-header-list">
            
            
                <div class="mobile-nav-item">
                    <a href="/">
                        <span>Article</span>
                        
                        
                    </a>
                </div>
            
            
            
                <div class="mobile-nav-item">
                    <a href="/archives">
                        <span>Archives</span>
                        
                        
                    </a>
                </div>
            
            
            
                <div class="mobile-nav-item inner-cloud">
                    <div class="mobile-nav-tag">
                        <a href="javascript:;" id="mobile-tags">
                            <span>Tags</span>
                            
                            
                        </a>
                    </div>
                    <div class="mobile-nav-tagcloud">
                        <div class="mobile-tagcloud-inner">
                            <a href="/tags/Dubbo/" style="font-size: 14px;">Dubbo</a> <a href="/tags/GitHub-Pages/" style="font-size: 14px;">GitHub Pages</a> <a href="/tags/IO/" style="font-size: 14px;">IO</a> <a href="/tags/JVM/" style="font-size: 14px;">JVM</a> <a href="/tags/Spring/" style="font-size: 14px;">Spring</a> <a href="/tags/Zookeeper/" style="font-size: 14px;">Zookeeper</a> <a href="/tags/walkup/" style="font-size: 14px;">walkup</a> <a href="/tags/分布式/" style="font-size: 14px;">分布式</a>
                        </div>
                    </div>
                </div>
            
            
            
                <div class="mobile-nav-item">
                    <a href="/about">
                        <span>About</span>
                        
                        
                    </a>
                </div>
            
            
        </div>
    </div>
    <div class="mobile-header-nav">
        <div class="mobile-header-item" id="mobile-left">
            <div class="header-menu-item">
                <span class="header-menu-line"></span>
            </div>
        </div>
        <h1 class="mobile-header-title">
            <a href="/">super2bai</a>
        </h1>
        <div class="mobile-header-item"></div>
    </div>
</div>

    <div class="container">
        <main class="main" id="main">
            
    
    <article class="post">
        <header class="post-header">
            <div class="post-time syuanpi riseIn-light back-1">
                <span>January 30, 2018</span>
                
            </div>
            <h1 class="post-title syuanpi riseIn-light back-2">
            
                HopSpot虚拟机对象探秘
            
            </h1>
            
                
                    <div class="post-tags syuanpi riseIn-light back-3">
                    
                        <a href="/tags/JVM/">JVM</a>
                    
                    </div>
                
            
        </header>
        <div class="post-content syuanpi riseIn-light back-3">
            
                <blockquote>
<p>阅读内容前提为</p>
<ul>
<li>虚拟机：HotSpot</li>
<li>内存区域：Java堆</li>
<li>内容： 对象分配、布局和访问的全过程</li>
<li>JDK版本：1.7</li>
</ul>
</blockquote>
<a id="more"></a>
<h2 id="对象的创建"><a href="#对象的创建" class="headerlink" title="对象的创建"></a>对象的创建</h2><blockquote>
<p>创建对象(例如克隆、反序列化)通常仅仅是一个<code>new</code>关键字而已。对应在JVM中，对象(普通Java对象，不包含数组和Class对象等)的创建是怎样的？</p>
</blockquote>
<h4 id="类加载检查"><a href="#类加载检查" class="headerlink" title="类加载检查"></a>类加载检查</h4><ul>
<li>参数是否能在<strong>常量池中定位到</strong>一个类的符号的引用</li>
<li>这个符号引用代表的类<strong>是否已经被加载、解析和初始化过</strong><ul>
<li>无：执行相应的类加载过程</li>
</ul>
</li>
</ul>
<h4 id="分配内存"><a href="#分配内存" class="headerlink" title="分配内存"></a>分配内存</h4><ul>
<li>对象所需内存的大小在类加载后便可完全确定</li>
<li>从Java堆中划分出确定大小的内存</li>
</ul>
<h5 id="分配方式"><a href="#分配方式" class="headerlink" title="分配方式"></a>分配方式</h5><blockquote>
<p>分配方式的选择：垃圾收集器是否带有压缩整理功能（决定Java堆是否规整）</p>
<ul>
<li>Serial、ParNew等带Compact过程的收集器<ul>
<li>指针碰撞</li>
</ul>
</li>
<li>基于Mark-Sweep算法的CMS收集器<ul>
<li>空闲列表</li>
</ul>
</li>
</ul>
</blockquote>
<ul>
<li>指针碰撞Bump the Pointer</li>
</ul>
<blockquote>
<p>Java堆中内存是<strong>绝对规整的</strong>，用过的内存在一边，空间内存在另外一边，中间用指针作为分界点的指示器，分配内存就是仅仅把指针向空闲内存挪动一段与对象大小相等的距离。</p>
</blockquote>
<ul>
<li>空闲列表Free List</li>
</ul>
<blockquote>
<p>Java堆中内存是<strong>不规整的</strong>，已使用的内存和空闲内存相互交错，虚拟机需维护一个列表，记录哪些内存块是可用的，在分配的时候从列表中找到一块足够大的空间划分给对象实例，并更新列表上的记录。</p>
</blockquote>
<h5 id="并发情况下对象创建非线程安全的问题"><a href="#并发情况下对象创建非线程安全的问题" class="headerlink" title="并发情况下对象创建非线程安全的问题"></a>并发情况下对象创建非线程安全的问题</h5><blockquote>
<p>对象创建行为非常频繁，并发情况下可能出现：正在给对象A分配内存，指针还没来得及修改，对象B又同时使用了原来的指针来分配内存。</p>
</blockquote>
<ul>
<li>对分配内存的操作进行同步处理<ul>
<li>虚拟机采用<strong>CAS+失败重试</strong>方法保证更新操作的原子性</li>
</ul>
</li>
<li>把内存分配的动作按照线程划分在不同的空间之中进行<ul>
<li>每个线程在Java堆中预先分配一小块内存，称为本地线程分配缓冲(Thread Loca Allocation Buffer,TLAB)</li>
<li>哪个线程需要分配内存就在对应的TLAB中进行</li>
<li>只有在TLAB用完并重新分配新的TLAB时，才需要同步锁定</li>
<li>虚拟机是否使用TLAB<ul>
<li><code>-XX:+/-UseTLAB</code>参数设置</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="内存空间初始化为零值-不包括对象头"><a href="#内存空间初始化为零值-不包括对象头" class="headerlink" title="内存空间初始化为零值(不包括对象头)"></a>内存空间初始化为零值(不包括对象头)</h4><ul>
<li>如果使用TLAB，可以提前至TLAB分配时进行此操作</li>
<li>保证了对象的实例字段在Java代码中可以不赋初始值就直接使用，访问到的字段的数据类型都是零值</li>
</ul>
<h4 id="对对象的对象头Object-Header进行设置"><a href="#对对象的对象头Object-Header进行设置" class="headerlink" title="对对象的对象头Object Header进行设置"></a>对对象的对象头Object Header进行设置</h4><ul>
<li>设置方式由<strong>虚拟机当前的运行状态</strong>决定<ul>
<li>是否启用偏向所等</li>
</ul>
</li>
</ul>
<ul>
<li>对象头包含内容<ul>
<li>这个对象时哪个类的实例</li>
<li>如何才能找到类的元数据信息、哈希码、GC分代年龄等</li>
</ul>
</li>
</ul>
<h4 id="可选：执行方法"><a href="#可选：执行方法" class="headerlink" title="可选：执行方法"></a>可选：执行<init>方法</init></h4><blockquote>
<p>至此，</p>
<ul>
<li>从虚拟机的角度看<ul>
<li>新对象已经产生了</li>
</ul>
</li>
<li>从Java程序的角度看<ul>
<li>对象创建才刚刚开始<ul>
<li><init>方法还没有执行</init></li>
<li>所有的字段都还为零</li>
</ul>
</li>
</ul>
</li>
</ul>
</blockquote>
<p>由字节码中是否跟随invokespecial指令所决定是否执行<init>方法，把对象按照程序员的意愿进行初始化，这样一个真正可用的对象才算完全产生出来。</init></p>
<h3 id="对象的内存布局"><a href="#对象的内存布局" class="headerlink" title="对象的内存布局"></a>对象的内存布局</h3><ul>
<li>在HotSpot中，对象在内存中存储的布局<ul>
<li>对象头Header</li>
<li>实例数据Instance Data</li>
<li>对齐填充Padding</li>
</ul>
</li>
</ul>
<h3 id="对象的访问定位"><a href="#对象的访问定位" class="headerlink" title="对象的访问定位"></a>对象的访问定位</h3>
            
        
        </div>
        
            
            
        
    </article>
    
        
    <nav class="article-page">
        
            <a href="/2018/03/15/WalkUp攻略-非洲/" id="art-left" class="art-right">
                <span class="next-title">
                    WalkUp攻略-非洲<i class="iconfont icon-right"></i> 
                </span>
            </a>
        
        
            <a href="/2018/01/30/WalkUp攻略-南极洲/" id="art-right" class="art-left">
                <span class="prev-title"> 
                    <i class="iconfont icon-left"></i>WalkUp攻略-南极洲
                </span>
            </a>
        
    </nav>

        
    


        </main>
        <footer class="footer syuanpi fadeIn" id="footer">
    <hr>
    <div class="footer-wrapper">
        <div class="left">
            <div class="contact-icon">
    
    
    
    
    
    
    
    
        
            <a href="https://github.com/super2bai" class="iconfont icon-github" title="github"></a>
        
        
        
        
        
        
        
    
</div>
        </div>
        <div class="right">
            <div class="copyright">
    <div class="info">
        <span>&copy;</span>
        <span>2017 ~ 2018</span>
        <span>❤</span>
        <span>super2bai</span>
    </div>
    <div class="theme">
        <span>
            Powered by
            <a href="http://hexo.io/" target="_blank">Hexo </a>
        </span>
        <span>
            Theme
            <a href="https://github.com/ColMugX/hexo-theme-Nlvi"> Nlvi </a>
        </span>
    </div>
    
    <div class="visit_count">
        <i class="iconfont icon-visit"></i>
        <span id="busuanzi_value_site_uv"></span>
        <i class="iconfont icon-people"></i>
        <span id="busuanzi_value_site_pv"></span>
    </div>
    
</div>
        </div>
    </div>
</footer>
    </div>
    <script src="/script/nlvi.js"></script>
<script src="/script/search.js"></script>

    <script src="/lightbox/js/lightbox.min.js"></script>

<script>
$(document).ready(function(){
    document.body.addEventListener('touchstart', function () {});
    $('.progress').hide();
    $('.body').show();
    Nlvi.tagcloud();
    Nlvi.mobileHeader();
    Nlvi.back2top();
    Nlvi.smoothScroll();
    Nlvi.onView();
    Nlvi.showToc();
    Nlvi.showComments();
    Nlvi.showReward();
    Nlvi.picPos();

    !CONFIG.animate && Nlvi.offAnimate();
    CONFIG.lightbox && Nlvi.onPicBox();
})
</script>
    </div>
    
        
    <div class="post-toc">
        <span class="title">文章目录</span>
        <div class="toc-inner syuanpi back-1 fallIn-light">
            <li class="title-link"><a href="javascript:;" class="toTop">HopSpot虚拟机对象探秘</a></li>
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#对象的创建"><span class="toc-text">对象的创建</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#类加载检查"><span class="toc-text">类加载检查</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#分配内存"><span class="toc-text">分配内存</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#分配方式"><span class="toc-text">分配方式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#并发情况下对象创建非线程安全的问题"><span class="toc-text">并发情况下对象创建非线程安全的问题</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#内存空间初始化为零值-不包括对象头"><span class="toc-text">内存空间初始化为零值(不包括对象头)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#对对象的对象头Object-Header进行设置"><span class="toc-text">对对象的对象头Object Header进行设置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#可选：执行方法"><span class="toc-text">可选：执行方法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#对象的内存布局"><span class="toc-text">对象的内存布局</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#对象的访问定位"><span class="toc-text">对象的访问定位</span></a></li></ol></li></ol>
        </div>
    </div>

    
    <div class="backtop syuanpi dead toTop" id="backtop">
    <i class="iconfont icon-up"></i>
    <span style="text-align:center;font-family:Georgia;"><span style="font-family:Georgia;" id="scrollpercent">1</span>%</span>
</div>
    
</body>
</html>
