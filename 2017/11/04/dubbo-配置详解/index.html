<!DOCTYPE html>
<html lang="">
<head>
    <title> dubbo配置详解 · super2bai </title>
    <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="browsermode" content="application">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="super2bai">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="msapplication-navbutton-color" content="#666666">
<meta name= "format-detection" content="telephone=no" />
<meta name="keywords" content="nlvi, Nlvi" />





    <meta name="keywords" content="Dubbo, Nlvi" />

<link rel="stylesheet" href="/style/style.css">
<script src="/script/jquery.min.js"></script>
<script>
    var CONFIG = {
        title: "super2bai",
        author: "super2bai",
        lightbox: true,
        animate: true
    }
</script>



    <link rel="stylesheet" href="/lightbox/css/lightbox.min.css">




    <link rel="stylesheet" href="/syuanpi/syuanpi.min.css">







  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-116557847-1', 'auto');
  ga('send', 'pageview');
</script>



    <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>


</head>
<body>
    <div class="progress">
    <div class="progress-inner"></div>
</div>
    <div class="body">
    <div class="tagcloud-mask"></div>  
<div class="tagcloud" id="tagcloud">
    <div class="tagcloud-inner">
        <a href="/tags/Dubbo/" style="font-size: 14px;">Dubbo</a> <a href="/tags/GitHub-Pages/" style="font-size: 14px;">GitHub Pages</a> <a href="/tags/IO/" style="font-size: 14px;">IO</a> <a href="/tags/JVM/" style="font-size: 14px;">JVM</a> <a href="/tags/Spring/" style="font-size: 14px;">Spring</a> <a href="/tags/Zookeeper/" style="font-size: 14px;">Zookeeper</a> <a href="/tags/walkup/" style="font-size: 14px;">walkup</a> <a href="/tags/分布式/" style="font-size: 14px;">分布式</a>
    </div>
</div>
    <header class="header" id="header">
    <div class="title syuanpi tvIn">
    <div class="table">
        <div class="connect">
            <div class="connect-inner">
                <span><a href="/">super2bai</a></span>
                
            </div>
        </div>
    </div>
</div>
    <nav class="main-nav syuanpi tvIn">
<div class="table">

    <ul class="menu">
        
        
        
            <li class="menu-item">
                <a href="/">
                    <span>Article</span>
                    
                    
                </a>
            </li>
        
        
        
            <li class="menu-item">
                <a href="/archives">
                    <span>Archives</span>
                    
                    
                </a>
            </li>
        
        
        
            <li class="menu-item">
                <a href="javascript:;" id="tags">
                    <span>Tags</span>
                    
                    
                </a>
            </li>
        
        
        
            <li class="menu-item">
                <a href="/about">
                    <span>About</span>
                    
                    
                </a>
            </li>
        
        
    </ul>

</div>
</nav>
</header>
<div class="mobile-header">
    <div class="mobile-header-body">
        <div class="mobile-header-list">
            
            
                <div class="mobile-nav-item">
                    <a href="/">
                        <span>Article</span>
                        
                        
                    </a>
                </div>
            
            
            
                <div class="mobile-nav-item">
                    <a href="/archives">
                        <span>Archives</span>
                        
                        
                    </a>
                </div>
            
            
            
                <div class="mobile-nav-item inner-cloud">
                    <div class="mobile-nav-tag">
                        <a href="javascript:;" id="mobile-tags">
                            <span>Tags</span>
                            
                            
                        </a>
                    </div>
                    <div class="mobile-nav-tagcloud">
                        <div class="mobile-tagcloud-inner">
                            <a href="/tags/Dubbo/" style="font-size: 14px;">Dubbo</a> <a href="/tags/GitHub-Pages/" style="font-size: 14px;">GitHub Pages</a> <a href="/tags/IO/" style="font-size: 14px;">IO</a> <a href="/tags/JVM/" style="font-size: 14px;">JVM</a> <a href="/tags/Spring/" style="font-size: 14px;">Spring</a> <a href="/tags/Zookeeper/" style="font-size: 14px;">Zookeeper</a> <a href="/tags/walkup/" style="font-size: 14px;">walkup</a> <a href="/tags/分布式/" style="font-size: 14px;">分布式</a>
                        </div>
                    </div>
                </div>
            
            
            
                <div class="mobile-nav-item">
                    <a href="/about">
                        <span>About</span>
                        
                        
                    </a>
                </div>
            
            
        </div>
    </div>
    <div class="mobile-header-nav">
        <div class="mobile-header-item" id="mobile-left">
            <div class="header-menu-item">
                <span class="header-menu-line"></span>
            </div>
        </div>
        <h1 class="mobile-header-title">
            <a href="/">super2bai</a>
        </h1>
        <div class="mobile-header-item"></div>
    </div>
</div>

    <div class="container">
        <main class="main" id="main">
            
    
    <article class="post">
        <header class="post-header">
            <div class="post-time syuanpi riseIn-light back-1">
                <span>November 4, 2017</span>
                
            </div>
            <h1 class="post-title syuanpi riseIn-light back-2">
            
                dubbo配置详解
            
            </h1>
            
                
                    <div class="post-tags syuanpi riseIn-light back-3">
                    
                        <a href="/tags/Dubbo/">Dubbo</a>
                    
                    </div>
                
            
        </header>
        <div class="post-content syuanpi riseIn-light back-3">
            
                <h3 id="启动服务检查"><a href="#启动服务检查" class="headerlink" title="启动服务检查"></a>启动服务检查</h3><a id="more"></a>
<blockquote>
<p>Dubbo 缺省会在启动时检查依赖的服务是否可用，不可用时会抛出异常，阻止 Spring 初始化完成，以便上线时，能及早发现问题，默认 <code>check=&quot;true&quot;</code>。</p>
</blockquote>
<ul>
<li><code>dubbo:reference</code><ul>
<li><code>check</code>属性<ul>
<li>true<ul>
<li>表示启动的时候检查依赖的服务是否正常</li>
</ul>
</li>
<li>false<ul>
<li>关闭检查</li>
<li>当服务出现循环依赖时</li>
<li>当有些服务不关心时</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>所有服务的启动时检查提供者</p>
</blockquote>
<ul>
<li><code>dubbo:consumer</code><ul>
<li><code>check</code>属性<ul>
<li>true</li>
<li>false<ul>
<li>没有服务提供者时报错</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>所有服务的启动时检查消费者</p>
</blockquote>
<ul>
<li>dubbo:provider<ul>
<li><code>check</code>属性<ul>
<li>false<ul>
<li>没有服务消费者失败报错 </li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>注册中心启动时检查注册订阅是否失败</p>
</blockquote>
<ul>
<li><code>dubbo:registry</code><ul>
<li><code>check</code>属性<ul>
<li>false<ul>
<li>注册订阅失败报错 </li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="多协议支持"><a href="#多协议支持" class="headerlink" title="多协议支持"></a>多协议支持</h3><ul>
<li>dobbo支持的协议<ul>
<li>dubbo://(TCP)<ul>
<li>介绍<ul>
<li>Dubbo缺省协议采用单一长连接和NIO异步通讯，适合于小数据量大并发的服务调用，以及服务消费者机器数远大于服务提供者机器数的情况。</li>
<li>反之，Dubbo 缺省协议不适合传送大数据量的服务，比如传文件，传视频等，除非请求量很低。</li>
<li>缺省协议，使用基于 mina <code>1.1.7</code> 和 hessian <code>3.2.1</code> 的 tbremoting 交互。</li>
</ul>
</li>
<li>约束<ul>
<li>参数及返回值需实现 <code>Serializable</code> 接口</li>
<li>参数及返回值不能自定义实现 <code>List</code>, <code>Map</code>, <code>Number</code>, <code>Date</code>, <code>Calendar</code> 等接口，只能用 JDK 自带的实现，因为 hessian 会做特殊处理，自定义实现类中的属性值都会丢失。</li>
</ul>
</li>
<li>常见问题<ul>
<li>为什么消费者比提供者个数多<ul>
<li>因dubbo协议采用单一长连接，假设网络为千兆网卡，根据测试经验数据每条连接最多只能压满7MByte(不同的环境可能不一样，供参考)，理论上1个服务提供者需要20个服务消费者才能压满网卡。</li>
</ul>
</li>
<li>为什么不能传大包<ul>
<li>因dubbo协议采用单一长连接，如果每次请求的数据包大小为500KByte，假设网络为千兆网卡，每条连接最大7MByte(不同环境可能不一样，供参考)，单个服务提供者的TPS(每秒处理事务数)最大为：128MByte/500KByte=262。单个消费者调用单个服务提供的TPS(每秒处理事务数)最大为7MByte/500KByte=14。如果能接受，可以考虑使用，否则网络将成为瓶颈。</li>
</ul>
</li>
<li>为什么采用异步单一长连接<ul>
<li>因为服务的现状大都是服务提供者少，通常只有机台机器，而服务的消费者多，可能整个网站都在访问改服务，比如Morgan的提供者只有6台，却有上百台消费者，每天有1.5亿次调用，如果采用常规的hessian服务，服务提供者很容易就被压垮，通过单一长连接，保证单一消费者不会压死提供者，长连接，减少连接握手验证等，并使用异步IO，复用线程池，防止<a href="http://www.kegel.com/c10k.html" target="_blank" rel="external">C10K问题</a>(C10K 就是 Client 10000 问题，即「在同时连接到服务器的客户端数量超过 10000 个的环境中，即便硬件性能足够， 依然无法正常提供服务」，简而言之，就是单机1万个并发连接问题。)。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>rmi://(TCP)<ul>
<li>介绍<ul>
<li>RMI 协议采用 JDK 标准的 <code>java.rmi.*</code> 实现，采用阻塞式短连接和 JDK 标准序列化方式。</li>
<li>注意：如果正在使用 RMI 提供服务给外部访问 <a href="https://dubbo.gitbooks.io/dubbo-user-book/content/references/protocol/rmi.html#fn_1" target="_blank" rel="external">1</a>，同时应用里依赖了老的 common-collections 包 <a href="https://dubbo.gitbooks.io/dubbo-user-book/content/references/protocol/rmi.html#fn_2" target="_blank" rel="external">2</a> 的情况下，存在反序列化安全风险 <a href="https://dubbo.gitbooks.io/dubbo-user-book/content/references/protocol/rmi.html#fn_3" target="_blank" rel="external">3</a>。</li>
</ul>
</li>
<li>约束<ul>
<li>数及返回值需实现<code>Serializable</code>接口</li>
<li>dubbo配置中的超时事件对RMI无效，需使用java启动参数设置：<code>-Dsun.rmi.transport.tcp.responseTimeout=3000</code></li>
</ul>
</li>
</ul>
</li>
<li>hessian://(http)<ul>
<li>介绍<ul>
<li>Hessian <a href="https://dubbo.gitbooks.io/dubbo-user-book/content/references/protocol/hessian.html#fn_1" target="_blank" rel="external">1</a> 协议用于集成 Hessian 的服务，Hessian 底层采用 Http 通讯，采用 Servlet 暴露服务，Dubbo 缺省内嵌 Jetty 作为服务器实现。</li>
<li>Dubbo 的 Hessian 协议可以和原生 Hessian 服务互操作，即：<ul>
<li>提供者用 Dubbo 的 Hessian 协议暴露服务，消费者直接用标准 Hessian 接口调用</li>
<li>或者提供方用标准 Hessian 暴露服务，消费方用 Dubbo 的 Hessian 协议调用。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>webservice://(http)</li>
<li><a href="http://(http" target="_blank" rel="external">http://(http</a>)</li>
<li>thrift://</li>
<li>memcached://</li>
<li>redis://</li>
</ul>
</li>
<li>改造协议</li>
<li>支持多协议</li>
</ul>
<h3 id="协议对比"><a href="#协议对比" class="headerlink" title="协议对比"></a>协议对比</h3><table>
<thead>
<tr>
<th style="text-align:center">协议</th>
<th>连接个数</th>
<th>连接方式</th>
<th>传输协议</th>
<th>传输方式</th>
<th>序列化</th>
<th>适用范围</th>
<th>适用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">dubbo://</td>
<td>单连接</td>
<td>长连接</td>
<td>TCP</td>
<td>NIO异步传输</td>
<td>Hessian二进制序列化</td>
<td>数据包较小(建议小于100K)，消费者比提供者个数多，单一消费者无法压满提供者，不要传输大文件或超大字符串</td>
<td>常规远程服务方法调用</td>
</tr>
<tr>
<td style="text-align:center">rmi://</td>
<td>多连接</td>
<td>短连接</td>
<td>TCP</td>
<td>同步传输</td>
<td>Java标准二进制序列化</td>
<td>数据包大小混合，消费者与提供者个数差不多，可传文件</td>
<td></td>
</tr>
<tr>
<td style="text-align:center">hessian://</td>
<td>多连接</td>
<td>短连接</td>
<td>HTTP</td>
<td>同步传输</td>
<td>Hessian二进制序列化</td>
<td>数据包较大，提供者比消费者个数多，提供者压力较大，可传文件</td>
<td>页面传输，文件传输，或与原生hessian服务互操作</td>
</tr>
<tr>
<td style="text-align:center">webservice://</td>
<td>多连接</td>
<td>短连接</td>
<td>HTTP</td>
<td>同步传输</td>
<td>SOAP文本序列化</td>
<td>系统集成，跨语言调用</td>
<td></td>
</tr>
<tr>
<td style="text-align:center">http://</td>
<td>多连接</td>
<td>短连接</td>
<td>HTTP</td>
<td>同步传输</td>
<td>表单序列化</td>
<td>数据包大小混合，提供者比消费者个数多，可用浏览器查看，可用表单或URL传入参数，暂不支持传文件</td>
<td>需同时给应用程序和浏览器JS使用的服务</td>
</tr>
</tbody>
</table>
<h3 id="代码演示-hessian"><a href="#代码演示-hessian" class="headerlink" title="代码演示(hessian)"></a>代码演示(hessian)</h3><h4 id="提供方增加maven依赖"><a href="#提供方增加maven依赖" class="headerlink" title="提供方增加maven依赖"></a>提供方增加maven依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.caucho<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hessian<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mortbay.jetty<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jetty<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.1.26<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<h4 id="提供方修改配置"><a href="#提供方修改配置" class="headerlink" title="提供方修改配置"></a>提供方修改配置</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dubbo:protocol</span> <span class="attr">name</span>=<span class="string">"hessian"</span> <span class="attr">port</span>=<span class="string">"8090"</span> <span class="attr">server</span>=<span class="string">"jetty"</span>/&gt;</span></div></pre></td></tr></table></figure>
<h4 id="提供方运行"><a href="#提供方运行" class="headerlink" title="提供方运行"></a>提供方运行</h4><p>控制台会输出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[com.alibaba.dubbo.config.AbstractConfig] -  [DUBBO] Export dubbo service com.bai.dubbo.order.IOrderService to url hessian:<span class="comment">//...</span></div></pre></td></tr></table></figure>
<h4 id="消费方修改配置"><a href="#消费方修改配置" class="headerlink" title="消费方修改配置"></a>消费方修改配置</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dubbo:protocol</span> <span class="attr">name</span>=<span class="string">"hessian"</span>/&gt;</span></div></pre></td></tr></table></figure>
<p>或者</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">...</span>  <span class="attr">protocol</span>=<span class="string">"hessian"</span>/&gt;</span></div></pre></td></tr></table></figure>
<h4 id="消费方运行"><a href="#消费方运行" class="headerlink" title="消费方运行"></a>消费方运行</h4><p>会提示成功</p>
<p>Ps：Maven的SNAPSHOT版本deploy后会直接替换仓库中的版本。release则不会。</p>
<h3 id="多注册中心"><a href="#多注册中心" class="headerlink" title="多注册中心"></a>多注册中心</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dubbo:registry</span>  <span class="attr">id</span>=<span class="string">"zkOne"</span> <span class="attr">protocol</span>=<span class="string">"zookeeper"</span> <span class="attr">address</span>=<span class="string">""</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dubbo:registry</span>  <span class="attr">id</span>=<span class="string">"zkTwo"</span> <span class="attr">protocol</span>=<span class="string">"zookeeper"</span> <span class="attr">address</span>=<span class="string">""</span>/&gt;</span></div></pre></td></tr></table></figure>
<p>或</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">registry</span>=<span class="string">"zkOne"</span> <span class="attr">...</span> /&gt;</span></div></pre></td></tr></table></figure>
<p><em>dubbo目前只支持Java</em></p>
<h3 id="多版本支持"><a href="#多版本支持" class="headerlink" title="多版本支持"></a>多版本支持</h3><p>对接口做版本控制，如一个接口升级后需要兼容。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!--提供方--&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">version</span>=<span class="string">"2.0"</span> <span class="attr">...</span> /&gt;</span></div></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!--消费方--&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">version</span>=<span class="string">"2.0"</span> <span class="attr">...</span> /&gt;</span></div></pre></td></tr></table></figure>
<p><em>发布服务时生成的URL中如没有版本号，那就是未采用版本控制。</em></p>
<h3 id="异步调用"><a href="#异步调用" class="headerlink" title="异步调用"></a>异步调用</h3><h4 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!--消费方--&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">async</span>=<span class="string">"true"</span> <span class="attr">...</span> /&gt;</span></div></pre></td></tr></table></figure>
<p><strong>hessian协议不支持，支持dubbo协议</strong></p>
<h4 id="消费方改造"><a href="#消费方改造" class="headerlink" title="消费方改造"></a>消费方改造</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.concurrent;</div><div class="line">service.doOrder(request);</div><div class="line">Future&lt;DoOrderResponse&gt; response=RpcContext.getContext().getFuture();</div><div class="line">System.out.println(response.get(););<span class="comment">//阻塞</span></div></pre></td></tr></table></figure>
<h3 id="主机绑定"><a href="#主机绑定" class="headerlink" title="主机绑定"></a>主机绑定</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * package com.alibaba.dubbo.config;</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 主机绑定的过程（取主机的地址）</span></div><div class="line"><span class="comment"> * 地址只能绑定一个</span></div><div class="line"><span class="comment"> * 1.通过&lt;dubbo:protocol host=""/&gt;配置的地址去找</span></div><div class="line"><span class="comment"> * 2.通过InetAddress.getLocalHost().getHostAddress();</span></div><div class="line"><span class="comment"> * 3.通过socket连接到注册中心的地址。再获取连接以后的本地地址</span></div><div class="line"><span class="comment"> * 4.getLocalHost() 网络接口</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="comment">// 如果没通过环境变量设置bind ip，则继续按优先级查找</span></div><div class="line"><span class="keyword">if</span> (hostToBind == <span class="keyword">null</span> || hostToBind.length() == <span class="number">0</span>) &#123;</div><div class="line">    <span class="comment">//&lt;dubbo:protocol host=""/&gt;配置的host内容</span></div><div class="line">    hostToBind = protocolConfig.getHost();</div><div class="line">    <span class="keyword">if</span> (provider != <span class="keyword">null</span> &amp;&amp; (hostToBind == <span class="keyword">null</span> || hostToBind.length() == <span class="number">0</span>)) &#123;</div><div class="line">        hostToBind = provider.getHost();</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//如果是否为合法的host</span></div><div class="line">    <span class="keyword">if</span> (isInvalidLocalHost(hostToBind)) &#123;</div><div class="line">        anyhost = <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">//换种方式拿host</span></div><div class="line">            hostToBind = InetAddress.getLocalHost().getHostAddress();</div><div class="line">        &#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</div><div class="line">            logger.warn(e.getMessage(), e);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//再次判断拿到的host是否合法</span></div><div class="line">        <span class="keyword">if</span> (isInvalidLocalHost(hostToBind)) &#123;</div><div class="line">            <span class="comment">//注册中心的URL</span></div><div class="line">            <span class="keyword">if</span> (registryURLs != <span class="keyword">null</span> &amp;&amp; registryURLs.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">for</span> (URL registryURL : registryURLs) &#123;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        Socket socket = <span class="keyword">new</span> Socket();</div><div class="line">                        <span class="keyword">try</span> &#123;</div><div class="line">                            <span class="comment">//通过socket去连注册中心的地址</span></div><div class="line">                            SocketAddress addr = <span class="keyword">new</span> InetSocketAddress(registryURL.getHost(), registryURL.getPort());</div><div class="line">                            socket.connect(addr, <span class="number">1000</span>);</div><div class="line">                            <span class="comment">//拿到socket连接的本地地址作为URL</span></div><div class="line">                            hostToBind = socket.getLocalAddress().getHostAddress();</div><div class="line">                            <span class="keyword">break</span>;</div><div class="line">                        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                            <span class="keyword">try</span> &#123;</div><div class="line">                                socket.close();</div><div class="line">                            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                        logger.warn(e.getMessage(), e);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">//上述操作都没有拿到</span></div><div class="line">            <span class="keyword">if</span> (isInvalidLocalHost(hostToBind)) &#123;</div><div class="line">                hostToBind = getLocalHost();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="dubbo服务只订阅"><a href="#dubbo服务只订阅" class="headerlink" title="dubbo服务只订阅"></a>dubbo服务只订阅</h3><blockquote>
<p> 所有的服务都只共用一个注册中心，其中一个服务正在开发，有问题，但注册到注册中心了。就会影响消费者不能正常运行。</p>
<p> 需要连注册中心使用服务，但又不能注册该服务。</p>
<p> 只订阅服务，不提供服务。</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">register</span>=<span class="string">"false"</span> <span class="attr">...</span>/&gt;</span></div></pre></td></tr></table></figure>
<h3 id="dubbo服务只注册"><a href="#dubbo服务只注册" class="headerlink" title="dubbo服务只注册"></a>dubbo服务只注册</h3><blockquote>
<p>有两个注册中心，服务只在其中一个注册中心部署，另外一个注册中心没有部署时，两个注册中心的其它服务都要依赖此服务。就需要把服务注册到两个注册中心。</p>
<p>只提供服务，不订阅服务。</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">subscribe</span>=<span class="string">"false"</span> <span class="attr">...</span>/&gt;</span></div></pre></td></tr></table></figure>
<h3 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h3><blockquote>
<p>在集群负载均衡时，Dubbo提供了多种均衡策略，缺省为random随机调用。可自行扩展负载均衡策略。</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">interface</span>=<span class="string">""</span> <span class="attr">loadbalance</span>=<span class="string">"roundrobin"</span>/&gt;</span></div></pre></td></tr></table></figure>
<h4 id="Random-LoadBalance"><a href="#Random-LoadBalance" class="headerlink" title="Random LoadBalance"></a>Random LoadBalance</h4><ul>
<li>随机，按权重设置随机概率。</li>
<li>在一个截面上碰撞的概率高，但调用量越大分布越均匀，而且按概率适用权重后也比较均匀，有利于动态调整提供者权重。</li>
</ul>
<h4 id="RoundRobin-LoadBalance"><a href="#RoundRobin-LoadBalance" class="headerlink" title="RoundRobin LoadBalance"></a>RoundRobin LoadBalance</h4><ul>
<li>轮循，按公约后的权重设置轮循比率。</li>
<li>存在慢的提供者累积请求的问题。<ul>
<li>第二台机器很慢，但没挂，当请求调到第二台时就卡在那，久而久之，所有请求都卡在调到第二台上。</li>
</ul>
</li>
</ul>
<h4 id="LeastActive-LoadBalance"><a href="#LeastActive-LoadBalance" class="headerlink" title="LeastActive LoadBalance"></a>LeastActive LoadBalance</h4><ul>
<li>最少活跃调用数，相同活跃数的随机。<ul>
<li>对于响应时间比较短的服务会优先</li>
<li>活跃数指调用前后计数差</li>
<li>使慢的提供者收到更少请求<ul>
<li>越慢的提供者的调用前后计数差会越大</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="ConsistentHash-LoadBalance"><a href="#ConsistentHash-LoadBalance" class="headerlink" title="ConsistentHash LoadBalance"></a>ConsistentHash LoadBalance</h4><ul>
<li>一致性Hash，相同参数的请求总是发到同一提供者。</li>
<li>当某一台提供者挂时，原本发往该提供者的请求，基于虚拟节点，平摊到其它提供者，不会引起剧烈变动。</li>
</ul>
<h3 id="连接超时Timeout"><a href="#连接超时Timeout" class="headerlink" title="连接超时Timeout"></a>连接超时Timeout</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!--单位为毫秒(常规5秒左右)--&gt;</span></div><div class="line"><span class="comment">&lt;!--处理时间过长，调用链会出现问题--&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dubbo:interface</span> <span class="attr">timeout</span>=<span class="string">"2000"</span>/&gt;</span></div></pre></td></tr></table></figure>
<p><strong>如果消费方和提供方都配置timeout属性，以消费方优先级最高，其次为提供方</strong></p>
<h3 id="集群容错"><a href="#集群容错" class="headerlink" title="集群容错"></a>集群容错</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">cluster</span>=<span class="string">"failfast"</span> <span class="attr">...</span>/&gt;</span></div></pre></td></tr></table></figure>
<h4 id="failover-cluster-默认"><a href="#failover-cluster-默认" class="headerlink" title="failover cluster(默认)"></a>failover cluster(默认)</h4><blockquote>
<p>失败的时候自动切换并重试其它服务器。</p>
<p>通过retries=2来设置重试次数</p>
</blockquote>
<h4 id="failfast-cluster"><a href="#failfast-cluster" class="headerlink" title="failfast cluster"></a>failfast cluster</h4><blockquote>
<p>快速失败，只发起一次调用。如果失败了，就失败了，不会重试。</p>
<p>写操作(例如新增记录等非幂等操作)如果重试会造成数据重复。</p>
</blockquote>
<h4 id="failfafe-cluster"><a href="#failfafe-cluster" class="headerlink" title="failfafe cluster"></a>failfafe cluster</h4><blockquote>
<p>失败安全。出现异常时，直接忽略异常(不会报异常)。</p>
<p>写日志时。无需保证日志一定写成功，但需保证主程序正常运行。</p>
</blockquote>
<h4 id="failback-cluster"><a href="#failback-cluster" class="headerlink" title="failback cluster"></a>failback cluster</h4><blockquote>
<p>失败自动恢复。后台记录失败请求，定时重发。</p>
<p>消息通知。</p>
</blockquote>
<h4 id="forking-cluster"><a href="#forking-cluster" class="headerlink" title="forking cluster"></a>forking cluster</h4><blockquote>
<p>并行调用多个服务器，只要一个成功就返回。</p>
<p>只能应用在读请求。</p>
<p>浪费服务器资源。</p>
</blockquote>
<h4 id="broadcast-cluster"><a href="#broadcast-cluster" class="headerlink" title="broadcast cluster"></a>broadcast cluster</h4><blockquote>
<p>广播调用所有提供者，逐个调用。其中一台报错就会返回异常。</p>
</blockquote>
<h3 id="配置优先级"><a href="#配置优先级" class="headerlink" title="配置优先级"></a>配置优先级</h3><p>消费方 <code>&gt;</code> 提供方</p>
<p>reference method <code>&gt;</code> service method <code>&gt;</code> reference <code>&gt;</code> service  <code>&gt;</code> consumer <code>&gt;</code> provider </p>

            
        
        </div>
        
            
            
        
    </article>
    
        
    <nav class="article-page">
        
            <a href="/2017/11/09/dubbo服务最佳实践/" id="art-left" class="art-right">
                <span class="next-title">
                    dubbo服务最佳实践<i class="iconfont icon-right"></i> 
                </span>
            </a>
        
        
            <a href="/2017/11/01/初步认识Dubbo/" id="art-right" class="art-left">
                <span class="prev-title"> 
                    <i class="iconfont icon-left"></i>初步认识Dubbo
                </span>
            </a>
        
    </nav>

        
    <i id="com-switch" class="iconfont icon-more jumping-in long infinite" style="font-size:24px;display:block;text-align:center;transform:rotate(180deg);"></i>
    <div class="post-comments" id="post-comments" style="display: block;margin: auto 16px;">
        
<!-- UY BEGIN -->
<div id="uyan_frame"></div>
<script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=2160088"></script>
<!-- UY END -->

        
<!-- Gitment Comments -->
<div id="gitment"></div>
<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<script>
var gitment = new Gitment({
  owner: "",
  repo: '',
  oauth: {
    client_id: '',
    client_secret: '',
  },
})
gitment.render('gitment')
</script>

        
<!-- SOHUCS Comments -->
<div id="SOHUCS"></div> 
<script type="text/javascript"> 
(function(){ 
var appid = '';
var conf = '';
var width = window.innerWidth || document.documentElement.clientWidth; 
if (width < 960) { 
window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="http://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf + '"><\/script>'); } else { var loadJs=function(d,a){var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;var b=document.createElement("script");b.setAttribute("type","text/javascript");b.setAttribute("charset","UTF-8");b.setAttribute("src",d);if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}c.appendChild(b)};loadJs("http://changyan.sohu.com/upload/changyan.js",function(){window.changyan.api.config({appid:appid,conf:conf})}); } })(); </script>

        

    </div>

    


        </main>
        <footer class="footer syuanpi fadeIn" id="footer">
    <hr>
    <div class="footer-wrapper">
        <div class="left">
            <div class="contact-icon">
    
    
    
    
    
    
    
    
        
            <a href="https://github.com/super2bai" class="iconfont icon-github" title="github"></a>
        
        
        
        
        
        
        
    
</div>
        </div>
        <div class="right">
            <div class="copyright">
    <div class="info">
        <span>&copy;</span>
        <span>2017 ~ 2018</span>
        <span>❤</span>
        <span>super2bai</span>
    </div>
    <div class="theme">
        <span>
            Powered by
            <a href="http://hexo.io/" target="_blank">Hexo </a>
        </span>
        <span>
            Theme
            <a href="https://github.com/ColMugX/hexo-theme-Nlvi"> Nlvi </a>
        </span>
    </div>
    
    <div class="visit_count">
        <i class="iconfont icon-visit"></i>
        <span id="busuanzi_value_site_uv"></span>
        <i class="iconfont icon-people"></i>
        <span id="busuanzi_value_site_pv"></span>
    </div>
    
</div>
        </div>
    </div>
</footer>
    </div>
    <script src="/script/nlvi.js"></script>
<script src="/script/search.js"></script>

    <script src="/lightbox/js/lightbox.min.js"></script>

<script>
$(document).ready(function(){
    document.body.addEventListener('touchstart', function () {});
    $('.progress').hide();
    $('.body').show();
    Nlvi.tagcloud();
    Nlvi.mobileHeader();
    Nlvi.back2top();
    Nlvi.smoothScroll();
    Nlvi.onView();
    Nlvi.showToc();
    Nlvi.showComments();
    Nlvi.showReward();
    Nlvi.picPos();

    !CONFIG.animate && Nlvi.offAnimate();
    CONFIG.lightbox && Nlvi.onPicBox();
})
</script>
    </div>
    
        
    <div class="post-toc">
        <span class="title">文章目录</span>
        <div class="toc-inner syuanpi back-1 fallIn-light">
            <li class="title-link"><a href="javascript:;" class="toTop">dubbo配置详解</a></li>
            <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#启动服务检查"><span class="toc-text">启动服务检查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#多协议支持"><span class="toc-text">多协议支持</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#协议对比"><span class="toc-text">协议对比</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#代码演示-hessian"><span class="toc-text">代码演示(hessian)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#提供方增加maven依赖"><span class="toc-text">提供方增加maven依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#提供方修改配置"><span class="toc-text">提供方修改配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#提供方运行"><span class="toc-text">提供方运行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#消费方修改配置"><span class="toc-text">消费方修改配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#消费方运行"><span class="toc-text">消费方运行</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#多注册中心"><span class="toc-text">多注册中心</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#多版本支持"><span class="toc-text">多版本支持</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#异步调用"><span class="toc-text">异步调用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#修改配置文件"><span class="toc-text">修改配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#消费方改造"><span class="toc-text">消费方改造</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#主机绑定"><span class="toc-text">主机绑定</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dubbo服务只订阅"><span class="toc-text">dubbo服务只订阅</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dubbo服务只注册"><span class="toc-text">dubbo服务只注册</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#负载均衡"><span class="toc-text">负载均衡</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Random-LoadBalance"><span class="toc-text">Random LoadBalance</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RoundRobin-LoadBalance"><span class="toc-text">RoundRobin LoadBalance</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LeastActive-LoadBalance"><span class="toc-text">LeastActive LoadBalance</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ConsistentHash-LoadBalance"><span class="toc-text">ConsistentHash LoadBalance</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#连接超时Timeout"><span class="toc-text">连接超时Timeout</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#集群容错"><span class="toc-text">集群容错</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#failover-cluster-默认"><span class="toc-text">failover cluster(默认)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#failfast-cluster"><span class="toc-text">failfast cluster</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#failfafe-cluster"><span class="toc-text">failfafe cluster</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#failback-cluster"><span class="toc-text">failback cluster</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#forking-cluster"><span class="toc-text">forking cluster</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#broadcast-cluster"><span class="toc-text">broadcast cluster</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置优先级"><span class="toc-text">配置优先级</span></a></li></ol>
        </div>
    </div>

    
    <div class="backtop syuanpi dead toTop" id="backtop">
    <i class="iconfont icon-up"></i>
    <span style="text-align:center;font-family:Georgia;"><span style="font-family:Georgia;" id="scrollpercent">1</span>%</span>
</div>
    
</body>
</html>
